/*---------------------------------------------------------------
 Programmer(s): Daniel R. Reynolds @ SMU
 ----------------------------------------------------------------
 Copyright (c) 2019, Southern Methodist University.
 All rights reserved.
 For details, see the LICENSE file.
 ----------------------------------------------------------------
 Implementation file for Dengo-based primordial chemistry network.

 This is essentially just a cut/paste from the Dengo autogenerated
 file
 https://github.com/hisunnytang/dengo-merge/blob/master/test_performance/final__solver.C

 It has been minimally modified in the following ways:

 * changed the #include line to utilize our wrap of their header file

 * #ifdef-ed out the X_main, dengo_evolve_X, final__solve_chemistry_dt,
   and read_init_data_to_dengo routines, as they are unused and require
   HDF5 and CVODE linkage.

 ---------------------------------------------------------------*/

#include <dengo_primordial_network.hpp>


#define IGNORED


//---- beginning of Dengo implementation file contents ----//


/* THIS FILE HAS BEEN AUTO-GENERATED.  DO NOT EDIT. */

/* This is C++ code to read HDF5 files for
   reaction rates, cooling rates, and initial
   conditions for the chemical network defined
   by the user.  In addition, this contains
   code for calculating temperature from the
   gas energy and computing the RHS and the
   Jacobian of the system of equations which
   will be fed into the solver.
*/


final__data *final__setup_data(
    int *NumberOfFields, char ***FieldNames)
{
    int i;

    final__data *data = (final__data *) malloc(sizeof(final__data));

    /* allocate space for the scale related pieces */
    for (i = 0; i< 10 ; i++){
        data->scale[i] = 1.0;
        data->inv_scale[i] = 1.0;
    }

    data->nstrip = MAX_NCELLS;
    /*initialize temperature so it wont crash*/
    for ( i = 0; i < MAX_NCELLS; i++ ){
        data->Ts[i] = 1000.0;
        data->logTs[i] = log(1000.0);
    }

    /* Temperature-related pieces */
    data->bounds[0] = 1.0;
    data->bounds[1] = 100000.0;
    data->nbins = 1024 - 1;
    data->dbin = (log(data->bounds[1]) - log(data->bounds[0])) / data->nbins;
    data->idbin = 1.0L / data->dbin;

    /* Redshift-related pieces */
    data->z_bounds[0] = 0.0;
    data->z_bounds[1] = 0.0;
    data->n_zbins = 0 - 1;
    data->d_zbin = (log(data->z_bounds[1] + 1.0) - log(data->z_bounds[0] + 1.0)) / data->n_zbins;
    data->id_zbin = 1.0L / data->d_zbin;

    final__read_rate_tables(data);
    fprintf(stderr, "Successfully read in rate tables.\n");

    final__read_cooling_tables(data);
    fprintf(stderr, "Successfully read in cooling rate tables.\n");

    final__read_gamma(data);
    fprintf(stderr, "Successfully read in gamma tables. \n");

    if (FieldNames != NULL && NumberOfFields != NULL) {
        NumberOfFields[0] = 10;
        FieldNames[0] = new char*[10];
        i = 0;

        FieldNames[0][i++] = strdup("H2_1");

        FieldNames[0][i++] = strdup("H2_2");

        FieldNames[0][i++] = strdup("H_1");

        FieldNames[0][i++] = strdup("H_2");

        FieldNames[0][i++] = strdup("H_m0");

        FieldNames[0][i++] = strdup("He_1");

        FieldNames[0][i++] = strdup("He_2");

        FieldNames[0][i++] = strdup("He_3");

        FieldNames[0][i++] = strdup("de");

        FieldNames[0][i++] = strdup("ge");

    }
    return data;

}

#ifndef IGNORED

int final__main(int argc, char** argv )
{
    final__data *data = final__setup_data(NULL, NULL);

    /* Initial conditions */
    hid_t file_id;
    if (argc < 2){
    file_id = H5Fopen("final__initial_conditions.h5", H5F_ACC_RDONLY, H5P_DEFAULT);
    if (file_id < 0) {fprintf(stderr, "Failed to open "
        "final__initial_conditions.h5 so dying.\n");
        return(1);}
    } else {
        file_id = H5Fopen( argv[1], H5F_ACC_RDONLY, H5P_DEFAULT);
        if (file_id < 0) {fprintf(stderr, "Failed to open  your initial_conditions file so dying.\n");
        return(1);}


    }

    /* Allocate the correct number of cells */
    hsize_t dims; /* We have flat versus number of species */

    /* Check gas energy to get the number of cells */
    fprintf(stderr, "Getting dimensionality from ge:\n");
    herr_t status = H5LTget_dataset_info(file_id, "/ge", &dims, NULL, NULL);
    if(status == -1) {
        fprintf(stderr, "Error opening initial conditions file.\n");
        return 1;
    }
    fprintf(stderr, "  ncells = % 3i\n", (int) dims);
    data->ncells = dims;

    int N = 10;

    double *atol, *rtol;
    atol = (double *) malloc(N * dims * sizeof(double));
    rtol = (double *) malloc(N * dims * sizeof(double));

    double *tics = (double *) malloc(dims * sizeof(double));
    double *ics = (double *) malloc(dims * N * sizeof(double));
    double *input = (double *) malloc(dims * N * sizeof(double));
    double *temp  = (double *) malloc(dims * sizeof(double) );

    unsigned int i = 0, j;

    fprintf(stderr, "Reading I.C. for /H2_1\n");
    H5LTread_dataset_double(file_id, "/H2_1", tics);
    for (j = 0; j < dims; j++) {
        ics[j * N + i] = tics[j];
        atol[j * N + i] = tics[j] * 1e-09;
        rtol[j * N + i] = 1e-09;
        if(j==0) {
            fprintf(stderr, "H2_1[0] = %0.3g, atol => % 0.16g\n",
                    tics[j], atol[j]);
        }
    }
    i++;

    fprintf(stderr, "Reading I.C. for /H2_2\n");
    H5LTread_dataset_double(file_id, "/H2_2", tics);
    for (j = 0; j < dims; j++) {
        ics[j * N + i] = tics[j];
        atol[j * N + i] = tics[j] * 1e-09;
        rtol[j * N + i] = 1e-09;
        if(j==0) {
            fprintf(stderr, "H2_2[0] = %0.3g, atol => % 0.16g\n",
                    tics[j], atol[j]);
        }
    }
    i++;

    fprintf(stderr, "Reading I.C. for /H_1\n");
    H5LTread_dataset_double(file_id, "/H_1", tics);
    for (j = 0; j < dims; j++) {
        ics[j * N + i] = tics[j];
        atol[j * N + i] = tics[j] * 1e-09;
        rtol[j * N + i] = 1e-09;
        if(j==0) {
            fprintf(stderr, "H_1[0] = %0.3g, atol => % 0.16g\n",
                    tics[j], atol[j]);
        }
    }
    i++;

    fprintf(stderr, "Reading I.C. for /H_2\n");
    H5LTread_dataset_double(file_id, "/H_2", tics);
    for (j = 0; j < dims; j++) {
        ics[j * N + i] = tics[j];
        atol[j * N + i] = tics[j] * 1e-09;
        rtol[j * N + i] = 1e-09;
        if(j==0) {
            fprintf(stderr, "H_2[0] = %0.3g, atol => % 0.16g\n",
                    tics[j], atol[j]);
        }
    }
    i++;

    fprintf(stderr, "Reading I.C. for /H_m0\n");
    H5LTread_dataset_double(file_id, "/H_m0", tics);
    for (j = 0; j < dims; j++) {
        ics[j * N + i] = tics[j];
        atol[j * N + i] = tics[j] * 1e-09;
        rtol[j * N + i] = 1e-09;
        if(j==0) {
            fprintf(stderr, "H_m0[0] = %0.3g, atol => % 0.16g\n",
                    tics[j], atol[j]);
        }
    }
    i++;

    fprintf(stderr, "Reading I.C. for /He_1\n");
    H5LTread_dataset_double(file_id, "/He_1", tics);
    for (j = 0; j < dims; j++) {
        ics[j * N + i] = tics[j];
        atol[j * N + i] = tics[j] * 1e-09;
        rtol[j * N + i] = 1e-09;
        if(j==0) {
            fprintf(stderr, "He_1[0] = %0.3g, atol => % 0.16g\n",
                    tics[j], atol[j]);
        }
    }
    i++;

    fprintf(stderr, "Reading I.C. for /He_2\n");
    H5LTread_dataset_double(file_id, "/He_2", tics);
    for (j = 0; j < dims; j++) {
        ics[j * N + i] = tics[j];
        atol[j * N + i] = tics[j] * 1e-09;
        rtol[j * N + i] = 1e-09;
        if(j==0) {
            fprintf(stderr, "He_2[0] = %0.3g, atol => % 0.16g\n",
                    tics[j], atol[j]);
        }
    }
    i++;

    fprintf(stderr, "Reading I.C. for /He_3\n");
    H5LTread_dataset_double(file_id, "/He_3", tics);
    for (j = 0; j < dims; j++) {
        ics[j * N + i] = tics[j];
        atol[j * N + i] = tics[j] * 1e-09;
        rtol[j * N + i] = 1e-09;
        if(j==0) {
            fprintf(stderr, "He_3[0] = %0.3g, atol => % 0.16g\n",
                    tics[j], atol[j]);
        }
    }
    i++;

    fprintf(stderr, "Reading I.C. for /de\n");
    H5LTread_dataset_double(file_id, "/de", tics);
    for (j = 0; j < dims; j++) {
        ics[j * N + i] = tics[j];
        atol[j * N + i] = tics[j] * 1e-09;
        rtol[j * N + i] = 1e-09;
        if(j==0) {
            fprintf(stderr, "de[0] = %0.3g, atol => % 0.16g\n",
                    tics[j], atol[j]);
        }
    }
    i++;

    fprintf(stderr, "Reading I.C. for /ge\n");
    H5LTread_dataset_double(file_id, "/ge", tics);
    for (j = 0; j < dims; j++) {
        ics[j * N + i] = tics[j];
        atol[j * N + i] = tics[j] * 1e-09;
        rtol[j * N + i] = 1e-09;
        if(j==0) {
            fprintf(stderr, "ge[0] = %0.3g, atol => % 0.16g\n",
                    tics[j], atol[j]);
        }
    }
    i++;


    double *density = (double *) malloc(dims *sizeof(double) );
    H5LTread_dataset_double(file_id, "/density", density);

    H5Fclose(file_id);

    /*
     * Use free fall time, not the time specified by
     * the network itself
     */


    // double dtf = 299204917.32712233;
    double dtf, t0;
    t0 = 2.992e15;
    dtf = t0 / sqrt(density[0]) * 1e0;

    // if the output time is specified,
    // it overrides the freefall time
    if (argc > 3){
        dtf = atof( argv[3] );
    }

    double dt = -1.0;
    double z = -1.0;
    for (i = 0; i < dims * N; i++) input[i] = ics[i];
    double ttot;
    ttot = dengo_evolve_final_(dtf, dt, z, input, rtol, atol, dims, data, temp);

    /* Write results to HDF5 file */

    if (argc < 3){
        file_id = H5Fcreate("final__solution.h5", H5F_ACC_TRUNC, H5P_DEFAULT, H5P_DEFAULT);
    } else{
        file_id = H5Fcreate( argv[2], H5F_ACC_TRUNC, H5P_DEFAULT, H5P_DEFAULT);
    }

    hsize_t dimsarr[1];
    dimsarr[0] = dims;
    i = 0;

    double H2_1[dims];
    for (j = 0; j < dims; j++) {
        H2_1[j] = input[j * N + i];
    }
    fprintf(stderr, "Writing solution for /H2_1\n");
    H5LTmake_dataset_double(file_id, "/H2_1", 1, dimsarr, H2_1);
    i++;

    double H2_2[dims];
    for (j = 0; j < dims; j++) {
        H2_2[j] = input[j * N + i];
    }
    fprintf(stderr, "Writing solution for /H2_2\n");
    H5LTmake_dataset_double(file_id, "/H2_2", 1, dimsarr, H2_2);
    i++;

    double H_1[dims];
    for (j = 0; j < dims; j++) {
        H_1[j] = input[j * N + i];
    }
    fprintf(stderr, "Writing solution for /H_1\n");
    H5LTmake_dataset_double(file_id, "/H_1", 1, dimsarr, H_1);
    i++;

    double H_2[dims];
    for (j = 0; j < dims; j++) {
        H_2[j] = input[j * N + i];
    }
    fprintf(stderr, "Writing solution for /H_2\n");
    H5LTmake_dataset_double(file_id, "/H_2", 1, dimsarr, H_2);
    i++;

    double H_m0[dims];
    for (j = 0; j < dims; j++) {
        H_m0[j] = input[j * N + i];
    }
    fprintf(stderr, "Writing solution for /H_m0\n");
    H5LTmake_dataset_double(file_id, "/H_m0", 1, dimsarr, H_m0);
    i++;

    double He_1[dims];
    for (j = 0; j < dims; j++) {
        He_1[j] = input[j * N + i];
    }
    fprintf(stderr, "Writing solution for /He_1\n");
    H5LTmake_dataset_double(file_id, "/He_1", 1, dimsarr, He_1);
    i++;

    double He_2[dims];
    for (j = 0; j < dims; j++) {
        He_2[j] = input[j * N + i];
    }
    fprintf(stderr, "Writing solution for /He_2\n");
    H5LTmake_dataset_double(file_id, "/He_2", 1, dimsarr, He_2);
    i++;

    double He_3[dims];
    for (j = 0; j < dims; j++) {
        He_3[j] = input[j * N + i];
    }
    fprintf(stderr, "Writing solution for /He_3\n");
    H5LTmake_dataset_double(file_id, "/He_3", 1, dimsarr, He_3);
    i++;

    double de[dims];
    for (j = 0; j < dims; j++) {
        de[j] = input[j * N + i];
    }
    fprintf(stderr, "Writing solution for /de\n");
    H5LTmake_dataset_double(file_id, "/de", 1, dimsarr, de);
    i++;

    double ge[dims];
    for (j = 0; j < dims; j++) {
        ge[j] = input[j * N + i];
    }
    fprintf(stderr, "Writing solution for /ge\n");
    H5LTmake_dataset_double(file_id, "/ge", 1, dimsarr, ge);
    i++;



    H5LTmake_dataset_double(file_id, "/T", 1, dimsarr, temp);

    double time[1];
    time[0] = ttot;
    double timestep[1];
    timestep[0] = dt;
    H5LTset_attribute_double(file_id, "/", "time", time, 1);
    H5LTset_attribute_double(file_id, "/", "timestep", timestep, 1);
    H5Fclose(file_id);

    free(temp);
    free(tics);
    free(ics);
    free(data);
    free(rtol);
    free(atol);
    free(input);

    return 0;
}



double dengo_evolve_final_ (double dtf, double &dt, double z, double *input,
            double *rtol, double *atol, long long dims, final__data *data, double *temp_array ) {
    int i, j;
    hid_t file_id;
    /* fprintf(stderr, "  ncells = % 3i\n", (int) dims); */
    int N = 10;
    double *mdensity = (double *) malloc (dims * N * sizeof(double));
    double H2_1;

    double H2_2;

    double H_1;

    double H_2;

    double H_m0;

    double He_1;

    double He_2;

    double He_3;

    double de;

    double ge;

    for (i = 0; i < dims; i++) {
        j = i * N;
        mdensity[i] = 0;

        mdensity[i] += input[j] ;
        H2_1 = input[j] /= 2.01588;


        j++;


        mdensity[i] += input[j] ;
        H2_2 = input[j] /= 2.01588;


        j++;


        mdensity[i] += input[j] ;
        H_1 = input[j] /= 1.00794;


        j++;


        mdensity[i] += input[j] ;
        H_2 = input[j] /= 1.00794;


        j++;


        mdensity[i] += input[j] ;
        H_m0 = input[j] /= 1.00794;


        j++;


        mdensity[i] += input[j] ;
        He_1 = input[j] /= 4.002602;


        j++;


        mdensity[i] += input[j] ;
        He_2 = input[j] /= 4.002602;


        j++;


        mdensity[i] += input[j] ;
        He_3 = input[j] /= 4.002602;


        j++;


        mdensity[i] += input[j] ;
        de = input[j] /= 1.0;


        j++;



        j++;


    }
    //ensure_electron_consistency(input, dims, N);

    rhs_f f = calculate_rhs_final_;

    #ifndef CVSPILS
    #ifdef  CVKLU
    jac_f jf = calculate_sparse_jacobian_final_;
    #else
    jac_f jf = calculate_jacobian_final_;
    #endif
    #endif

    #ifdef CVSPILS
    jac_f jf = calculate_JacTimesVec_final_;
    #endif

    if (dt < 0) dt = dtf / 1e0;
    data->current_z = z;
    int niter = 0;
    int siter = 0;
    double ttot = 0;
    double *scale = (double *) malloc(dims * N * sizeof(double));
    double *ttot_all = (double *) malloc( dims * sizeof(double) );

    for (i = 0; i < dims * N; i++) scale[i] = input[i];


    double floor_value = 1e-25;

    // Initialize a CVODE object, memory spaces
    // and attach rhs, jac to them
    int flag;
    double reltol = 1.0e-4;
    void *cvode_mem;
    int MAX_ITERATION = 100;
    double mh = 1.67e-24;
    int nstrip = data->nstrip;

    SUNLinearSolver LS;
    SUNMatrix A;
    N_Vector y_vec, abstol;

    // inputs are now grouped into a batch of nstrip
    // and send into the CVode solver
    //
    // ntimes: the number of times the CVode solver will be called
    // v_size: the size of the input vector for the solver
    //       : v_size = N * nstrip

    int v_size = N * nstrip;
    int ntimes = dims / nstrip;
    double y[10 * v_size];

    y_vec = NULL;
    LS = NULL;
    A  = NULL;

    y_vec  = N_VNew_Serial( v_size );
    abstol = N_VNew_Serial( v_size );

    for (i = 0; i < v_size ; i++) {
        NV_Ith_S(y_vec ,i)   = 1.0;
        NV_Ith_S(abstol,i)   = 1.0;
        y[i] = 1.0;
    }

    #ifdef CVKLU
    A         = SUNSparseMatrix      ( v_size, v_size, nstrip * 64, CSR_MAT );
    LS        = SUNKLU( y_vec, A);
    #else
    A         = SUNDenseMatrix      ( v_size, v_size );
    LS        = SUNDenseLinearSolver( y_vec, A);
    #endif

    cvode_mem = setup_cvode_solver  ( f, jf, v_size , data, LS, A, y_vec, reltol, abstol);

    for (int d = 0; d < ntimes; d++){

        for (i = 0; i < v_size; i++){

            data->scale[i]         = input[d*v_size + i];
            data->inv_scale[i]     = 1.0 / data->scale[i];
            NV_Ith_S(y_vec , i )   = 1.0;
            NV_Ith_S(abstol, i )   = reltol*reltol;
        }

        for ( j = 0; j < nstrip; j++){
            data->mdensity[j]      = mdensity[ d*nstrip + j ] * mh;
            data->inv_mdensity[j]  = 1.0 / data->mdensity[j];
        }
        // initialize a dt for the solver
        dt = dtf/MAX_ITERATION;
        ttot = 0.0;
        siter = 0;

        while (ttot < dtf) {
            fprintf(stderr, "%d th strip: %d iterations, time: %0.5g\n", d, siter, ttot );

            flag = cvode_solver( cvode_mem, y, N * nstrip , &dt, data, y_vec, reltol, abstol);

            for (i = 0; i < v_size; i++) {
                if (y[i] < 0) {
                    fprintf(stderr, "negative \n");
                    flag = 1;
                    break;
                }
            }

            for (i = 0; i < v_size ; i++){
                NV_Ith_S(y_vec , i )   = 1.0;
                NV_Ith_S(abstol, i )   = reltol*reltol;
            }

            if (flag < 1){
                // flag = 0 => success
                // we reset the scale of each component
                // with the solution returned by the solver
                for (i = 0; i < v_size; i++){
                    data->scale[i] = y[i] * data->scale[i];
                    data->inv_scale[i] = 1.0/ data->scale[i];
                    // fprintf(stderr , "data->scale[%d] = %0.5g \n", i,y[i]);
                }

                ttot += dt;
                //dt = dtf - ttot;
                dt *= 1.1;
            } else{
                dt /= 2.0;
                //dt = DMIN(dt * 1.1, dtf - ttot);
            }


            if (siter == MAX_ITERATION) break;


            siter++;
        } // while loop for each strip

        //fprintf(stderr, "%d the strip = %0.5g\n", d, ttot);

        // re-calculate temperature at the final output
        final__calculate_temperature(data, data->scale, nstrip, N);

        for ( i = 0; i < nstrip; i ++){
            temp_array[ d * nstrip + i ] = data->Ts[ i ];
            ttot_all  [ d * nstrip + i ] = ttot;
        }

        for (i = 0; i < v_size; i++){
            input     [ d * v_size + i ] = data->scale[i] ;
        } // copy data back to the input array
    } // for d dims loop

    // free all unused memory;
    CVodeFree(&cvode_mem);
    SUNLinSolFree(LS);
    SUNMatDestroy(A);
    N_VDestroy(y_vec);
    N_VDestroy(abstol);
    free(scale);
    free(mdensity);
    for (i = 0; i < dims; i++) {
      j = i * N;

      H2_1 = input[j];
      input[j] *= 2.01588;


      j++;


      H2_2 = input[j];
      input[j] *= 2.01588;


      j++;


      H_1 = input[j];
      input[j] *= 1.00794;


      j++;


      H_2 = input[j];
      input[j] *= 1.00794;


      j++;


      H_m0 = input[j];
      input[j] *= 1.00794;


      j++;


      He_1 = input[j];
      input[j] *= 4.002602;


      j++;


      He_2 = input[j];
      input[j] *= 4.002602;


      j++;


      He_3 = input[j];
      input[j] *= 4.002602;


      j++;


      de = input[j];
      input[j] *= 1.0;


      j++;



      j++;

    }

    double dt_final = dtf;

    for (int d = 0; d < dims; d++){
        if (ttot_all[d] < dt_final) dt_final = ttot_all[d];
    }
    free(ttot_all);

    return dt_final;
}
#endif



void final__read_rate_tables(final__data *data)
{
    hid_t file_id = H5Fopen("final__tables.h5", H5F_ACC_RDONLY, H5P_DEFAULT);
    /* Allocate the correct number of rate tables */
    H5LTread_dataset_double(file_id, "/k01", data->r_k01);
    H5LTread_dataset_double(file_id, "/k02", data->r_k02);
    H5LTread_dataset_double(file_id, "/k03", data->r_k03);
    H5LTread_dataset_double(file_id, "/k04", data->r_k04);
    H5LTread_dataset_double(file_id, "/k05", data->r_k05);
    H5LTread_dataset_double(file_id, "/k06", data->r_k06);
    H5LTread_dataset_double(file_id, "/k07", data->r_k07);
    H5LTread_dataset_double(file_id, "/k08", data->r_k08);
    H5LTread_dataset_double(file_id, "/k09", data->r_k09);
    H5LTread_dataset_double(file_id, "/k10", data->r_k10);
    H5LTread_dataset_double(file_id, "/k11", data->r_k11);
    H5LTread_dataset_double(file_id, "/k12", data->r_k12);
    H5LTread_dataset_double(file_id, "/k13", data->r_k13);
    H5LTread_dataset_double(file_id, "/k14", data->r_k14);
    H5LTread_dataset_double(file_id, "/k15", data->r_k15);
    H5LTread_dataset_double(file_id, "/k16", data->r_k16);
    H5LTread_dataset_double(file_id, "/k17", data->r_k17);
    H5LTread_dataset_double(file_id, "/k18", data->r_k18);
    H5LTread_dataset_double(file_id, "/k19", data->r_k19);
    H5LTread_dataset_double(file_id, "/k21", data->r_k21);
    H5LTread_dataset_double(file_id, "/k22", data->r_k22);

    H5Fclose(file_id);
}

void final__read_cooling_tables(final__data *data)
{

    hid_t file_id = H5Fopen("final__tables.h5", H5F_ACC_RDONLY, H5P_DEFAULT);
    /* Allocate the correct number of rate tables */
    H5LTread_dataset_double(file_id, "/brem_brem",
                            data->c_brem_brem);
    H5LTread_dataset_double(file_id, "/ceHeI_ceHeI",
                            data->c_ceHeI_ceHeI);
    H5LTread_dataset_double(file_id, "/ceHeII_ceHeII",
                            data->c_ceHeII_ceHeII);
    H5LTread_dataset_double(file_id, "/ceHI_ceHI",
                            data->c_ceHI_ceHI);
    H5LTread_dataset_double(file_id, "/ciHeI_ciHeI",
                            data->c_ciHeI_ciHeI);
    H5LTread_dataset_double(file_id, "/ciHeII_ciHeII",
                            data->c_ciHeII_ciHeII);
    H5LTread_dataset_double(file_id, "/ciHeIS_ciHeIS",
                            data->c_ciHeIS_ciHeIS);
    H5LTread_dataset_double(file_id, "/ciHI_ciHI",
                            data->c_ciHI_ciHI);
    H5LTread_dataset_double(file_id, "/compton_comp_",
                            data->c_compton_comp_);
    H5LTread_dataset_double(file_id, "/gammah_gammah",
                            data->c_gammah_gammah);
    H5LTread_dataset_double(file_id, "/gloverabel08_gael",
                            data->c_gloverabel08_gael);
    H5LTread_dataset_double(file_id, "/gloverabel08_gaH2",
                            data->c_gloverabel08_gaH2);
    H5LTread_dataset_double(file_id, "/gloverabel08_gaHe",
                            data->c_gloverabel08_gaHe);
    H5LTread_dataset_double(file_id, "/gloverabel08_gaHI",
                            data->c_gloverabel08_gaHI);
    H5LTread_dataset_double(file_id, "/gloverabel08_gaHp",
                            data->c_gloverabel08_gaHp);
    H5LTread_dataset_double(file_id, "/gloverabel08_gphdl",
                            data->c_gloverabel08_gphdl);
    H5LTread_dataset_double(file_id, "/gloverabel08_gpldl",
                            data->c_gloverabel08_gpldl);
    H5LTread_dataset_double(file_id, "/gloverabel08_h2lte",
                            data->c_gloverabel08_h2lte);
    H5LTread_dataset_double(file_id, "/h2formation_h2mcool",
                            data->c_h2formation_h2mcool);
    H5LTread_dataset_double(file_id, "/h2formation_h2mheat",
                            data->c_h2formation_h2mheat);
    H5LTread_dataset_double(file_id, "/h2formation_ncrd1",
                            data->c_h2formation_ncrd1);
    H5LTread_dataset_double(file_id, "/h2formation_ncrd2",
                            data->c_h2formation_ncrd2);
    H5LTread_dataset_double(file_id, "/h2formation_ncrn",
                            data->c_h2formation_ncrn);
    H5LTread_dataset_double(file_id, "/reHeII1_reHeII1",
                            data->c_reHeII1_reHeII1);
    H5LTread_dataset_double(file_id, "/reHeII2_reHeII2",
                            data->c_reHeII2_reHeII2);
    H5LTread_dataset_double(file_id, "/reHeIII_reHeIII",
                            data->c_reHeIII_reHeIII);
    H5LTread_dataset_double(file_id, "/reHII_reHII",
                            data->c_reHII_reHII);

    H5Fclose(file_id);
}

void final__read_gamma(final__data *data)
{

    hid_t file_id = H5Fopen("final__tables.h5", H5F_ACC_RDONLY, H5P_DEFAULT);
    /* Allocate the correct number of rate tables */
    H5LTread_dataset_double(file_id, "/gammaH2_1",
                            data->g_gammaH2_1 );
    H5LTread_dataset_double(file_id, "/dgammaH2_1_dT",
                            data->g_dgammaH2_1_dT );

    H5LTread_dataset_double(file_id, "/gammaH2_2",
                            data->g_gammaH2_2 );
    H5LTread_dataset_double(file_id, "/dgammaH2_2_dT",
                            data->g_dgammaH2_2_dT );


    H5Fclose(file_id);

}



int final__calculate_temperature(final__data *data,
                        double *input, int nstrip, int nchem)
{
    int i, j;
    double density, T, Tnew;
    double kb = 1.3806504e-16; // Boltzmann constant [erg/K]
    double mh = 1.67e-24;
    double gamma = 5.e0/3.e0;
    double _gamma_m1 = 1.0 / (gamma - 1);


    double gammaH2 = 7.e0/5.e0; // Should be a function of temperature
    	   	     		// this is a temporary solution
    double dge_dT;
    double dge;


    double gammaH2_1;
    double dgammaH2_1_dT;
    double _gammaH2_1_m1;

    double gammaH2_2;
    double dgammaH2_2_dT;
    double _gammaH2_2_m1;


    double Tdiff = 1.0;
    int MAX_T_ITERATION = 100;
    int count = 0;





    /* Calculate total density */
    double H2_1;
    double H2_2;
    double H_1;
    double H_2;
    double H_m0;
    double He_1;
    double He_2;
    double He_3;
    double de;
    double ge;


    i = 0;

    for ( i = 0; i < nstrip; i++ ){
        j = i * nchem;
        H2_1 = input[j];
        j++;

        H2_2 = input[j];
        j++;

        H_1 = input[j];
        j++;

        H_2 = input[j];
        j++;

        H_m0 = input[j];
        j++;

        He_1 = input[j];
        j++;

        He_2 = input[j];
        j++;

        He_3 = input[j];
        j++;

        de = input[j];
        j++;

        ge = input[j];
        j++;




        density = 2.01588*H2_1 + 2.01588*H2_2 + 1.00794*H_1 + 1.00794*H_2 + 1.00794*H_m0 + 4.002602*He_1 + 4.002602*He_2 + 4.002602*He_3;




        // Initiate the "guess" temperature
        T    = data->Ts[i];
        Tnew = T*1.1;

        Tdiff = Tnew - T;
        count = 0;

        while ( Tdiff/ Tnew > 0.001 ){
            // We do Newton's Iteration to calculate the temperature
            // Since gammaH2 is dependent on the temperature too!

            T = data->Ts[i];

            final__interpolate_gamma(data, i);

            gammaH2_1 = data->gammaH2_1[i];
            dgammaH2_1_dT = data->dgammaH2_1_dT[i];
            _gammaH2_1_m1 = 1.0 / (gammaH2_1 - 1.0);
            // fprintf(stderr, ":gammaH2_1 %0.5g , dgammaH2_1_dT: %.5g \n", gammaH2_1, dgammaH2_1_dT  );

            gammaH2_2 = data->gammaH2_2[i];
            dgammaH2_2_dT = data->dgammaH2_2_dT[i];
            _gammaH2_2_m1 = 1.0 / (gammaH2_2 - 1.0);
            // fprintf(stderr, ":gammaH2_2 %0.5g , dgammaH2_2_dT: %.5g \n", gammaH2_2, dgammaH2_2_dT  );



            // update gammaH2
            // The derivatives of  sum (nkT/(gamma - 1)/mh/density) - ge
            // This is the function we want to minimize
            // which should only be dependent on the first part
            dge_dT = T*kb*(-H2_1*_gammaH2_1_m1*_gammaH2_1_m1*dgammaH2_1_dT - H2_2*_gammaH2_2_m1*_gammaH2_2_m1*dgammaH2_2_dT)/(density*mh) + kb*(H2_1*_gammaH2_1_m1 + H2_2*_gammaH2_2_m1 + H_1*_gamma_m1 + H_2*_gamma_m1 + H_m0*_gamma_m1 + He_1*_gamma_m1 + He_2*_gamma_m1 + He_3*_gamma_m1 + _gamma_m1*de)/(density*mh);

            //This is the change in ge for each iteration
            dge = T*kb*(H2_1*_gammaH2_1_m1 + H2_2*_gammaH2_2_m1 + H_1*_gamma_m1 + H_2*_gamma_m1 + H_m0*_gamma_m1 + He_1*_gamma_m1 + He_2*_gamma_m1 + He_3*_gamma_m1 + _gamma_m1*de)/(density*mh) - ge;

            Tnew = T - dge/dge_dT;
            data->Ts[i] = Tnew;

            Tdiff = fabs(T - Tnew);
            // fprintf(stderr, "T: %0.5g ; Tnew: %0.5g; dge_dT: %.5g, dge: %.5g, ge: %.5g \n", T,Tnew, dge_dT, dge, ge);
            count += 1;
            if (count > MAX_T_ITERATION){
                fprintf(stderr, "T failed to converge \n");
                return 1;
            }
        } // while loop

        data->Ts[i] = Tnew;


        // fprintf(stderr,"T : %0.5g, density : %0.5g, d_gammaH2: %0.5g \n", Tnew, density, gammaH2 - 7./5.);




        if (data->Ts[i] < data->bounds[0]) {
            data->Ts[i] = data->bounds[0];
        } else if (data->Ts[i] > data->bounds[1]) {
            data->Ts[i] = data->bounds[1];
        }
        data->logTs[i] = log(data->Ts[i]);
        data->invTs[i] = 1.0 / data->Ts[i];
	    data->dTs_ge[i] = 1.0 / dge_dT;

    } // for i in nstrip loop
    return 0;

}



/*
   This setup may be different than the user may anticipate, as a result
   of the lockstep timestep we use for a pencil beam through the grid.
   As such, it accepts the number of things to interpolate and makes
   assumptions about the sizes of the rates.
*/

/* This also requires no templating other than for the solver name...*/
void final__interpolate_rates(final__data *data,
                    int nstrip)
{
    int i, bin_id, zbin_id;
    double lb, t1, t2;
    double lbz, z1, z2, Tdef, zdef;
    int no_photo = 0;
    lb = log(data->bounds[0]);
    lbz = log(data->z_bounds[0] + 1.0);

    i = 0;

    for ( i = 0; i < nstrip; i++ ){
        data->bin_id[i] = bin_id = (int) (data->idbin * (data->logTs[i] - lb));
        if (data->bin_id[i] <= 0) {
            data->bin_id[i] = 0;
        } else if (data->bin_id[i] >= data->nbins) {
            data->bin_id[i] = data->nbins - 1;
        }
        t1 = (lb + (bin_id    ) * data->dbin);
        t2 = (lb + (bin_id + 1) * data->dbin);
        data->Tdef[i] = (data->logTs[i] - t1)/(t2 - t1);
        data->dT[i] = (t2 - t1);
        /*fprintf(stderr, "INTERP: %d, bin_id = %d, dT = % 0.16g, T = % 0.16g, logT = % 0.16g\n",
                i, data->bin_id[i], data->dT[i], data->Ts[i],
                data->logTs[i]);*/

    if ((data->current_z >= data->z_bounds[0]) && (data->current_z < data->z_bounds[1])) {
        zbin_id = (int) (data->id_zbin * (log(data->current_z + 1.0) - lbz));
        if (zbin_id <= 0) {
            zbin_id = 0;
        } else if (zbin_id >= data->n_zbins) {
            zbin_id = data->n_zbins - 1;
        }
        z1 = (lbz + (zbin_id    ) * data->d_zbin);
        z2 = (lbz + (zbin_id + 1) * data->d_zbin);
        data->zdef = (log(data->current_z + 1.0) - z1)/(z2 - z1);
        data->dz = (exp(z2) - exp(z1)); //note: given this, we don't have to divide rate of change by z
    } else {
        no_photo = 1;
    }
    }

    zdef   = data->zdef;



    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->rs_k01[i] = data->r_k01[bin_id] +
            Tdef * (data->r_k01[bin_id+1] - data->r_k01[bin_id]);
        data->drs_k01[i] = (data->r_k01[bin_id+1] - data->r_k01[bin_id]);
        data->drs_k01[i] /= data->dT[i];
	    data->drs_k01[i] *= data->invTs[i];

    }


    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->rs_k02[i] = data->r_k02[bin_id] +
            Tdef * (data->r_k02[bin_id+1] - data->r_k02[bin_id]);
        data->drs_k02[i] = (data->r_k02[bin_id+1] - data->r_k02[bin_id]);
        data->drs_k02[i] /= data->dT[i];
	    data->drs_k02[i] *= data->invTs[i];

    }


    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->rs_k03[i] = data->r_k03[bin_id] +
            Tdef * (data->r_k03[bin_id+1] - data->r_k03[bin_id]);
        data->drs_k03[i] = (data->r_k03[bin_id+1] - data->r_k03[bin_id]);
        data->drs_k03[i] /= data->dT[i];
	    data->drs_k03[i] *= data->invTs[i];

    }


    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->rs_k04[i] = data->r_k04[bin_id] +
            Tdef * (data->r_k04[bin_id+1] - data->r_k04[bin_id]);
        data->drs_k04[i] = (data->r_k04[bin_id+1] - data->r_k04[bin_id]);
        data->drs_k04[i] /= data->dT[i];
	    data->drs_k04[i] *= data->invTs[i];

    }


    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->rs_k05[i] = data->r_k05[bin_id] +
            Tdef * (data->r_k05[bin_id+1] - data->r_k05[bin_id]);
        data->drs_k05[i] = (data->r_k05[bin_id+1] - data->r_k05[bin_id]);
        data->drs_k05[i] /= data->dT[i];
	    data->drs_k05[i] *= data->invTs[i];

    }


    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->rs_k06[i] = data->r_k06[bin_id] +
            Tdef * (data->r_k06[bin_id+1] - data->r_k06[bin_id]);
        data->drs_k06[i] = (data->r_k06[bin_id+1] - data->r_k06[bin_id]);
        data->drs_k06[i] /= data->dT[i];
	    data->drs_k06[i] *= data->invTs[i];

    }


    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->rs_k07[i] = data->r_k07[bin_id] +
            Tdef * (data->r_k07[bin_id+1] - data->r_k07[bin_id]);
        data->drs_k07[i] = (data->r_k07[bin_id+1] - data->r_k07[bin_id]);
        data->drs_k07[i] /= data->dT[i];
	    data->drs_k07[i] *= data->invTs[i];

    }


    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->rs_k08[i] = data->r_k08[bin_id] +
            Tdef * (data->r_k08[bin_id+1] - data->r_k08[bin_id]);
        data->drs_k08[i] = (data->r_k08[bin_id+1] - data->r_k08[bin_id]);
        data->drs_k08[i] /= data->dT[i];
	    data->drs_k08[i] *= data->invTs[i];

    }


    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->rs_k09[i] = data->r_k09[bin_id] +
            Tdef * (data->r_k09[bin_id+1] - data->r_k09[bin_id]);
        data->drs_k09[i] = (data->r_k09[bin_id+1] - data->r_k09[bin_id]);
        data->drs_k09[i] /= data->dT[i];
	    data->drs_k09[i] *= data->invTs[i];

    }


    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->rs_k10[i] = data->r_k10[bin_id] +
            Tdef * (data->r_k10[bin_id+1] - data->r_k10[bin_id]);
        data->drs_k10[i] = (data->r_k10[bin_id+1] - data->r_k10[bin_id]);
        data->drs_k10[i] /= data->dT[i];
	    data->drs_k10[i] *= data->invTs[i];

    }


    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->rs_k11[i] = data->r_k11[bin_id] +
            Tdef * (data->r_k11[bin_id+1] - data->r_k11[bin_id]);
        data->drs_k11[i] = (data->r_k11[bin_id+1] - data->r_k11[bin_id]);
        data->drs_k11[i] /= data->dT[i];
	    data->drs_k11[i] *= data->invTs[i];

    }


    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->rs_k12[i] = data->r_k12[bin_id] +
            Tdef * (data->r_k12[bin_id+1] - data->r_k12[bin_id]);
        data->drs_k12[i] = (data->r_k12[bin_id+1] - data->r_k12[bin_id]);
        data->drs_k12[i] /= data->dT[i];
	    data->drs_k12[i] *= data->invTs[i];

    }


    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->rs_k13[i] = data->r_k13[bin_id] +
            Tdef * (data->r_k13[bin_id+1] - data->r_k13[bin_id]);
        data->drs_k13[i] = (data->r_k13[bin_id+1] - data->r_k13[bin_id]);
        data->drs_k13[i] /= data->dT[i];
	    data->drs_k13[i] *= data->invTs[i];

    }


    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->rs_k14[i] = data->r_k14[bin_id] +
            Tdef * (data->r_k14[bin_id+1] - data->r_k14[bin_id]);
        data->drs_k14[i] = (data->r_k14[bin_id+1] - data->r_k14[bin_id]);
        data->drs_k14[i] /= data->dT[i];
	    data->drs_k14[i] *= data->invTs[i];

    }


    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->rs_k15[i] = data->r_k15[bin_id] +
            Tdef * (data->r_k15[bin_id+1] - data->r_k15[bin_id]);
        data->drs_k15[i] = (data->r_k15[bin_id+1] - data->r_k15[bin_id]);
        data->drs_k15[i] /= data->dT[i];
	    data->drs_k15[i] *= data->invTs[i];

    }


    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->rs_k16[i] = data->r_k16[bin_id] +
            Tdef * (data->r_k16[bin_id+1] - data->r_k16[bin_id]);
        data->drs_k16[i] = (data->r_k16[bin_id+1] - data->r_k16[bin_id]);
        data->drs_k16[i] /= data->dT[i];
	    data->drs_k16[i] *= data->invTs[i];

    }


    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->rs_k17[i] = data->r_k17[bin_id] +
            Tdef * (data->r_k17[bin_id+1] - data->r_k17[bin_id]);
        data->drs_k17[i] = (data->r_k17[bin_id+1] - data->r_k17[bin_id]);
        data->drs_k17[i] /= data->dT[i];
	    data->drs_k17[i] *= data->invTs[i];

    }


    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->rs_k18[i] = data->r_k18[bin_id] +
            Tdef * (data->r_k18[bin_id+1] - data->r_k18[bin_id]);
        data->drs_k18[i] = (data->r_k18[bin_id+1] - data->r_k18[bin_id]);
        data->drs_k18[i] /= data->dT[i];
	    data->drs_k18[i] *= data->invTs[i];

    }


    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->rs_k19[i] = data->r_k19[bin_id] +
            Tdef * (data->r_k19[bin_id+1] - data->r_k19[bin_id]);
        data->drs_k19[i] = (data->r_k19[bin_id+1] - data->r_k19[bin_id]);
        data->drs_k19[i] /= data->dT[i];
	    data->drs_k19[i] *= data->invTs[i];

    }


    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->rs_k21[i] = data->r_k21[bin_id] +
            Tdef * (data->r_k21[bin_id+1] - data->r_k21[bin_id]);
        data->drs_k21[i] = (data->r_k21[bin_id+1] - data->r_k21[bin_id]);
        data->drs_k21[i] /= data->dT[i];
	    data->drs_k21[i] *= data->invTs[i];

    }


    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->rs_k22[i] = data->r_k22[bin_id] +
            Tdef * (data->r_k22[bin_id+1] - data->r_k22[bin_id]);
        data->drs_k22[i] = (data->r_k22[bin_id+1] - data->r_k22[bin_id]);
        data->drs_k22[i] /= data->dT[i];
	    data->drs_k22[i] *= data->invTs[i];

    }

    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->cs_brem_brem[i] = data->c_brem_brem[bin_id] +
            Tdef * (data->c_brem_brem[bin_id+1] - data->c_brem_brem[bin_id]);
        data->dcs_brem_brem[i] = (data->c_brem_brem[bin_id+1] - data->c_brem_brem[bin_id]);
        data->dcs_brem_brem[i] /= data->dT[i];
	    data->dcs_brem_brem[i] *= data->invTs[i];
    }

    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->cs_ceHeI_ceHeI[i] = data->c_ceHeI_ceHeI[bin_id] +
            Tdef * (data->c_ceHeI_ceHeI[bin_id+1] - data->c_ceHeI_ceHeI[bin_id]);
        data->dcs_ceHeI_ceHeI[i] = (data->c_ceHeI_ceHeI[bin_id+1] - data->c_ceHeI_ceHeI[bin_id]);
        data->dcs_ceHeI_ceHeI[i] /= data->dT[i];
	    data->dcs_ceHeI_ceHeI[i] *= data->invTs[i];
    }

    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->cs_ceHeII_ceHeII[i] = data->c_ceHeII_ceHeII[bin_id] +
            Tdef * (data->c_ceHeII_ceHeII[bin_id+1] - data->c_ceHeII_ceHeII[bin_id]);
        data->dcs_ceHeII_ceHeII[i] = (data->c_ceHeII_ceHeII[bin_id+1] - data->c_ceHeII_ceHeII[bin_id]);
        data->dcs_ceHeII_ceHeII[i] /= data->dT[i];
	    data->dcs_ceHeII_ceHeII[i] *= data->invTs[i];
    }

    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->cs_ceHI_ceHI[i] = data->c_ceHI_ceHI[bin_id] +
            Tdef * (data->c_ceHI_ceHI[bin_id+1] - data->c_ceHI_ceHI[bin_id]);
        data->dcs_ceHI_ceHI[i] = (data->c_ceHI_ceHI[bin_id+1] - data->c_ceHI_ceHI[bin_id]);
        data->dcs_ceHI_ceHI[i] /= data->dT[i];
	    data->dcs_ceHI_ceHI[i] *= data->invTs[i];
    }

    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->cs_ciHeI_ciHeI[i] = data->c_ciHeI_ciHeI[bin_id] +
            Tdef * (data->c_ciHeI_ciHeI[bin_id+1] - data->c_ciHeI_ciHeI[bin_id]);
        data->dcs_ciHeI_ciHeI[i] = (data->c_ciHeI_ciHeI[bin_id+1] - data->c_ciHeI_ciHeI[bin_id]);
        data->dcs_ciHeI_ciHeI[i] /= data->dT[i];
	    data->dcs_ciHeI_ciHeI[i] *= data->invTs[i];
    }

    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->cs_ciHeII_ciHeII[i] = data->c_ciHeII_ciHeII[bin_id] +
            Tdef * (data->c_ciHeII_ciHeII[bin_id+1] - data->c_ciHeII_ciHeII[bin_id]);
        data->dcs_ciHeII_ciHeII[i] = (data->c_ciHeII_ciHeII[bin_id+1] - data->c_ciHeII_ciHeII[bin_id]);
        data->dcs_ciHeII_ciHeII[i] /= data->dT[i];
	    data->dcs_ciHeII_ciHeII[i] *= data->invTs[i];
    }

    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->cs_ciHeIS_ciHeIS[i] = data->c_ciHeIS_ciHeIS[bin_id] +
            Tdef * (data->c_ciHeIS_ciHeIS[bin_id+1] - data->c_ciHeIS_ciHeIS[bin_id]);
        data->dcs_ciHeIS_ciHeIS[i] = (data->c_ciHeIS_ciHeIS[bin_id+1] - data->c_ciHeIS_ciHeIS[bin_id]);
        data->dcs_ciHeIS_ciHeIS[i] /= data->dT[i];
	    data->dcs_ciHeIS_ciHeIS[i] *= data->invTs[i];
    }

    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->cs_ciHI_ciHI[i] = data->c_ciHI_ciHI[bin_id] +
            Tdef * (data->c_ciHI_ciHI[bin_id+1] - data->c_ciHI_ciHI[bin_id]);
        data->dcs_ciHI_ciHI[i] = (data->c_ciHI_ciHI[bin_id+1] - data->c_ciHI_ciHI[bin_id]);
        data->dcs_ciHI_ciHI[i] /= data->dT[i];
	    data->dcs_ciHI_ciHI[i] *= data->invTs[i];
    }

    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->cs_compton_comp_[i] = data->c_compton_comp_[bin_id] +
            Tdef * (data->c_compton_comp_[bin_id+1] - data->c_compton_comp_[bin_id]);
        data->dcs_compton_comp_[i] = (data->c_compton_comp_[bin_id+1] - data->c_compton_comp_[bin_id]);
        data->dcs_compton_comp_[i] /= data->dT[i];
	    data->dcs_compton_comp_[i] *= data->invTs[i];
    }

    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->cs_gammah_gammah[i] = data->c_gammah_gammah[bin_id] +
            Tdef * (data->c_gammah_gammah[bin_id+1] - data->c_gammah_gammah[bin_id]);
        data->dcs_gammah_gammah[i] = (data->c_gammah_gammah[bin_id+1] - data->c_gammah_gammah[bin_id]);
        data->dcs_gammah_gammah[i] /= data->dT[i];
	    data->dcs_gammah_gammah[i] *= data->invTs[i];
    }

    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->cs_gloverabel08_gael[i] = data->c_gloverabel08_gael[bin_id] +
            Tdef * (data->c_gloverabel08_gael[bin_id+1] - data->c_gloverabel08_gael[bin_id]);
        data->dcs_gloverabel08_gael[i] = (data->c_gloverabel08_gael[bin_id+1] - data->c_gloverabel08_gael[bin_id]);
        data->dcs_gloverabel08_gael[i] /= data->dT[i];
	    data->dcs_gloverabel08_gael[i] *= data->invTs[i];
    }
    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->cs_gloverabel08_gaH2[i] = data->c_gloverabel08_gaH2[bin_id] +
            Tdef * (data->c_gloverabel08_gaH2[bin_id+1] - data->c_gloverabel08_gaH2[bin_id]);
        data->dcs_gloverabel08_gaH2[i] = (data->c_gloverabel08_gaH2[bin_id+1] - data->c_gloverabel08_gaH2[bin_id]);
        data->dcs_gloverabel08_gaH2[i] /= data->dT[i];
	    data->dcs_gloverabel08_gaH2[i] *= data->invTs[i];
    }
    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->cs_gloverabel08_gaHe[i] = data->c_gloverabel08_gaHe[bin_id] +
            Tdef * (data->c_gloverabel08_gaHe[bin_id+1] - data->c_gloverabel08_gaHe[bin_id]);
        data->dcs_gloverabel08_gaHe[i] = (data->c_gloverabel08_gaHe[bin_id+1] - data->c_gloverabel08_gaHe[bin_id]);
        data->dcs_gloverabel08_gaHe[i] /= data->dT[i];
	    data->dcs_gloverabel08_gaHe[i] *= data->invTs[i];
    }
    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->cs_gloverabel08_gaHI[i] = data->c_gloverabel08_gaHI[bin_id] +
            Tdef * (data->c_gloverabel08_gaHI[bin_id+1] - data->c_gloverabel08_gaHI[bin_id]);
        data->dcs_gloverabel08_gaHI[i] = (data->c_gloverabel08_gaHI[bin_id+1] - data->c_gloverabel08_gaHI[bin_id]);
        data->dcs_gloverabel08_gaHI[i] /= data->dT[i];
	    data->dcs_gloverabel08_gaHI[i] *= data->invTs[i];
    }
    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->cs_gloverabel08_gaHp[i] = data->c_gloverabel08_gaHp[bin_id] +
            Tdef * (data->c_gloverabel08_gaHp[bin_id+1] - data->c_gloverabel08_gaHp[bin_id]);
        data->dcs_gloverabel08_gaHp[i] = (data->c_gloverabel08_gaHp[bin_id+1] - data->c_gloverabel08_gaHp[bin_id]);
        data->dcs_gloverabel08_gaHp[i] /= data->dT[i];
	    data->dcs_gloverabel08_gaHp[i] *= data->invTs[i];
    }
    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->cs_gloverabel08_gphdl[i] = data->c_gloverabel08_gphdl[bin_id] +
            Tdef * (data->c_gloverabel08_gphdl[bin_id+1] - data->c_gloverabel08_gphdl[bin_id]);
        data->dcs_gloverabel08_gphdl[i] = (data->c_gloverabel08_gphdl[bin_id+1] - data->c_gloverabel08_gphdl[bin_id]);
        data->dcs_gloverabel08_gphdl[i] /= data->dT[i];
	    data->dcs_gloverabel08_gphdl[i] *= data->invTs[i];
    }
    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->cs_gloverabel08_gpldl[i] = data->c_gloverabel08_gpldl[bin_id] +
            Tdef * (data->c_gloverabel08_gpldl[bin_id+1] - data->c_gloverabel08_gpldl[bin_id]);
        data->dcs_gloverabel08_gpldl[i] = (data->c_gloverabel08_gpldl[bin_id+1] - data->c_gloverabel08_gpldl[bin_id]);
        data->dcs_gloverabel08_gpldl[i] /= data->dT[i];
	    data->dcs_gloverabel08_gpldl[i] *= data->invTs[i];
    }
    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->cs_gloverabel08_h2lte[i] = data->c_gloverabel08_h2lte[bin_id] +
            Tdef * (data->c_gloverabel08_h2lte[bin_id+1] - data->c_gloverabel08_h2lte[bin_id]);
        data->dcs_gloverabel08_h2lte[i] = (data->c_gloverabel08_h2lte[bin_id+1] - data->c_gloverabel08_h2lte[bin_id]);
        data->dcs_gloverabel08_h2lte[i] /= data->dT[i];
	    data->dcs_gloverabel08_h2lte[i] *= data->invTs[i];
    }

    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->cs_h2formation_h2mcool[i] = data->c_h2formation_h2mcool[bin_id] +
            Tdef * (data->c_h2formation_h2mcool[bin_id+1] - data->c_h2formation_h2mcool[bin_id]);
        data->dcs_h2formation_h2mcool[i] = (data->c_h2formation_h2mcool[bin_id+1] - data->c_h2formation_h2mcool[bin_id]);
        data->dcs_h2formation_h2mcool[i] /= data->dT[i];
	    data->dcs_h2formation_h2mcool[i] *= data->invTs[i];
    }
    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->cs_h2formation_h2mheat[i] = data->c_h2formation_h2mheat[bin_id] +
            Tdef * (data->c_h2formation_h2mheat[bin_id+1] - data->c_h2formation_h2mheat[bin_id]);
        data->dcs_h2formation_h2mheat[i] = (data->c_h2formation_h2mheat[bin_id+1] - data->c_h2formation_h2mheat[bin_id]);
        data->dcs_h2formation_h2mheat[i] /= data->dT[i];
	    data->dcs_h2formation_h2mheat[i] *= data->invTs[i];
    }
    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->cs_h2formation_ncrd1[i] = data->c_h2formation_ncrd1[bin_id] +
            Tdef * (data->c_h2formation_ncrd1[bin_id+1] - data->c_h2formation_ncrd1[bin_id]);
        data->dcs_h2formation_ncrd1[i] = (data->c_h2formation_ncrd1[bin_id+1] - data->c_h2formation_ncrd1[bin_id]);
        data->dcs_h2formation_ncrd1[i] /= data->dT[i];
	    data->dcs_h2formation_ncrd1[i] *= data->invTs[i];
    }
    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->cs_h2formation_ncrd2[i] = data->c_h2formation_ncrd2[bin_id] +
            Tdef * (data->c_h2formation_ncrd2[bin_id+1] - data->c_h2formation_ncrd2[bin_id]);
        data->dcs_h2formation_ncrd2[i] = (data->c_h2formation_ncrd2[bin_id+1] - data->c_h2formation_ncrd2[bin_id]);
        data->dcs_h2formation_ncrd2[i] /= data->dT[i];
	    data->dcs_h2formation_ncrd2[i] *= data->invTs[i];
    }
    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->cs_h2formation_ncrn[i] = data->c_h2formation_ncrn[bin_id] +
            Tdef * (data->c_h2formation_ncrn[bin_id+1] - data->c_h2formation_ncrn[bin_id]);
        data->dcs_h2formation_ncrn[i] = (data->c_h2formation_ncrn[bin_id+1] - data->c_h2formation_ncrn[bin_id]);
        data->dcs_h2formation_ncrn[i] /= data->dT[i];
	    data->dcs_h2formation_ncrn[i] *= data->invTs[i];
    }

    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->cs_reHeII1_reHeII1[i] = data->c_reHeII1_reHeII1[bin_id] +
            Tdef * (data->c_reHeII1_reHeII1[bin_id+1] - data->c_reHeII1_reHeII1[bin_id]);
        data->dcs_reHeII1_reHeII1[i] = (data->c_reHeII1_reHeII1[bin_id+1] - data->c_reHeII1_reHeII1[bin_id]);
        data->dcs_reHeII1_reHeII1[i] /= data->dT[i];
	    data->dcs_reHeII1_reHeII1[i] *= data->invTs[i];
    }

    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->cs_reHeII2_reHeII2[i] = data->c_reHeII2_reHeII2[bin_id] +
            Tdef * (data->c_reHeII2_reHeII2[bin_id+1] - data->c_reHeII2_reHeII2[bin_id]);
        data->dcs_reHeII2_reHeII2[i] = (data->c_reHeII2_reHeII2[bin_id+1] - data->c_reHeII2_reHeII2[bin_id]);
        data->dcs_reHeII2_reHeII2[i] /= data->dT[i];
	    data->dcs_reHeII2_reHeII2[i] *= data->invTs[i];
    }

    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->cs_reHeIII_reHeIII[i] = data->c_reHeIII_reHeIII[bin_id] +
            Tdef * (data->c_reHeIII_reHeIII[bin_id+1] - data->c_reHeIII_reHeIII[bin_id]);
        data->dcs_reHeIII_reHeIII[i] = (data->c_reHeIII_reHeIII[bin_id+1] - data->c_reHeIII_reHeIII[bin_id]);
        data->dcs_reHeIII_reHeIII[i] /= data->dT[i];
	    data->dcs_reHeIII_reHeIII[i] *= data->invTs[i];
    }

    for ( i = 0; i < nstrip; i++ ){
        bin_id = data->bin_id[i];
        Tdef   = data->Tdef[i];
        data->cs_reHII_reHII[i] = data->c_reHII_reHII[bin_id] +
            Tdef * (data->c_reHII_reHII[bin_id+1] - data->c_reHII_reHII[bin_id]);
        data->dcs_reHII_reHII[i] = (data->c_reHII_reHII[bin_id+1] - data->c_reHII_reHII[bin_id]);
        data->dcs_reHII_reHII[i] /= data->dT[i];
	    data->dcs_reHII_reHII[i] *= data->invTs[i];
    }


}



void final__interpolate_gamma(final__data *data,
                    int i)
{

    /*
     * find the bin_id for the given temperature
     * update dT for i_th strip
     */

    int bin_id, zbin_id;
    double lb, t1, t2;
    double lbz, z1, z2;
    int no_photo = 0;
    lb = log(data->bounds[0]);
    lbz = log(data->z_bounds[0] + 1.0);

    data->bin_id[i] = bin_id = (int) (data->idbin * (data->logTs[i] - lb));
    if (data->bin_id[i] <= 0) {
        data->bin_id[i] = 0;
    } else if (data->bin_id[i] >= data->nbins) {
        data->bin_id[i] = data->nbins - 1;
    }
    t1 = (lb + (bin_id    ) * data->dbin);
    t2 = (lb + (bin_id + 1) * data->dbin);
    data->Tdef[i] = (data->logTs[i] - t1)/(t2 - t1);
    data->dT[i] = (t2 - t1);



    bin_id = data->bin_id[i];
    data->gammaH2_2[i] = data->g_gammaH2_2[bin_id] +
        data->Tdef[i] * (data->g_gammaH2_2[bin_id+1] - data->g_gammaH2_2[bin_id]);

    data->dgammaH2_2_dT[i] = data->g_dgammaH2_2_dT[bin_id] +
        data->Tdef[i] * (data->g_dgammaH2_2_dT[bin_id+1]
        - data->g_dgammaH2_2_dT[bin_id]);


    bin_id = data->bin_id[i];
    data->gammaH2_1[i] = data->g_gammaH2_1[bin_id] +
        data->Tdef[i] * (data->g_gammaH2_1[bin_id+1] - data->g_gammaH2_1[bin_id]);

    data->dgammaH2_1_dT[i] = data->g_dgammaH2_1_dT[bin_id] +
        data->Tdef[i] * (data->g_dgammaH2_1_dT[bin_id+1]
        - data->g_dgammaH2_1_dT[bin_id]);


    }






void ensure_electron_consistency(double *input, int nstrip, int nchem)
{
    int i, j;

    /* Now we set up some temporaries */
    double H2_1;
    double H2_2;
    double H_1;
    double H_2;
    double H_m0;
    double He_1;
    double He_2;
    double He_3;
    double de;
    double ge;
    double total_e = 0.0;
    int e_indx;

    double scale;

    for (i = 0; i<nstrip; i++) {
        j = i * nchem;
        H2_1 = input[j];

        total_e += H2_1 * 0.0;

        j++;

        H2_2 = input[j];

        total_e += H2_2 * 1.0;

        j++;

        H_1 = input[j];

        total_e += H_1 * 0.0;

        j++;

        H_2 = input[j];

        total_e += H_2 * 1.0;

        j++;

        H_m0 = input[j];

        total_e += H_m0 * -1.0;

        j++;

        He_1 = input[j];

        total_e += He_1 * 0.0;

        j++;

        He_2 = input[j];

        total_e += He_2 * 1.0;

        j++;

        He_3 = input[j];

        total_e += He_3 * 2.0;

        j++;

        de = input[j];

        e_indx = j;

        j++;

        ge = input[j];


        j++;

        input[e_indx] = total_e;
    }
}




void temperature_from_mass_density(double *input, int nstrip,
                                   int nchem, double *strip_temperature)
{
    int i, j;
    double density;
    double kb = 1.3806504e-16; // Boltzmann constant [erg/K]
    double mh = 1.67e-24;
    double gamma = 5.e0/3.e0;
    double _gamma_m1 = 1.0 / (gamma - 1.0);

    double gammaH2 = 7.e0/5.e0; // Should be a function of temperature
    	   	     		// this is a temporary solution

    double T =  1000.0; // THIS IS TEMPORARY!!! DELTETE!!


    double H2_1;
    double H2_2;
    double H_1;
    double H_2;
    double H_m0;
    double He_1;
    double He_2;
    double He_3;
    double de;
    double ge;

    double scale;

    for (i = 0; i<nstrip; i++) {
        j = i * nchem;
        H2_1 = input[j];

        H2_1 /= 2.01588 * mh;

        /*fprintf(stderr, "H2_1[%d] = % 0.16g\n",
                i, H2_1);*/
        j++;

        H2_2 = input[j];

        H2_2 /= 2.01588 * mh;

        /*fprintf(stderr, "H2_2[%d] = % 0.16g\n",
                i, H2_2);*/
        j++;

        H_1 = input[j];

        H_1 /= 1.00794 * mh;

        /*fprintf(stderr, "H_1[%d] = % 0.16g\n",
                i, H_1);*/
        j++;

        H_2 = input[j];

        H_2 /= 1.00794 * mh;

        /*fprintf(stderr, "H_2[%d] = % 0.16g\n",
                i, H_2);*/
        j++;

        H_m0 = input[j];

        H_m0 /= 1.00794 * mh;

        /*fprintf(stderr, "H_m0[%d] = % 0.16g\n",
                i, H_m0);*/
        j++;

        He_1 = input[j];

        He_1 /= 4.002602 * mh;

        /*fprintf(stderr, "He_1[%d] = % 0.16g\n",
                i, He_1);*/
        j++;

        He_2 = input[j];

        He_2 /= 4.002602 * mh;

        /*fprintf(stderr, "He_2[%d] = % 0.16g\n",
                i, He_2);*/
        j++;

        He_3 = input[j];

        He_3 /= 4.002602 * mh;

        /*fprintf(stderr, "He_3[%d] = % 0.16g\n",
                i, He_3);*/
        j++;

        de = input[j];

        de /= 1.0 * mh;

        /*fprintf(stderr, "de[%d] = % 0.16g\n",
                i, de);*/
        j++;

        ge = input[j];

        /*fprintf(stderr, "ge[%d] = % 0.16g\n",
                i, ge);*/
        j++;

        density = 2.01588*H2_1 + 2.01588*H2_2 + 1.00794*H_1 + 1.00794*H_2 + 1.00794*H_m0 + 4.002602*He_1 + 4.002602*He_2 + 4.002602*He_3;
        strip_temperature[i] = density*ge*mh/(kb*(H2_1/(gammaH2 - 1.0) + H2_2/(gammaH2 - 1.0) + H_1*_gamma_m1 + H_2*_gamma_m1 + H_m0*_gamma_m1 + He_1*_gamma_m1 + He_2*_gamma_m1 + He_3*_gamma_m1 + _gamma_m1*de));
        if (strip_temperature[i] < 1.0)
            strip_temperature[i] = 1.0;
    }

}



int calculate_jacobian_final_( realtype t,
                                        N_Vector y, N_Vector fy,
                                        SUNMatrix J, void *user_data,
                                        N_Vector tmp1, N_Vector tmp2,
                                        N_Vector tmp3)
{
    /* We iterate over all of the rates */
    /* Calcuate temperature first */


    final__data *data = (final__data*)user_data;

    int nchem = 10;
    int nstrip = data->nstrip;
    int i, j;

    /* change N_Vector back to an array */
    double y_arr[ 10 * nstrip ];
    double *scale     = data->scale;
    double *inv_scale = data->inv_scale;

    for ( i = 0; i < nstrip; i++ ){
        j = i * nchem;
        y_arr[j] = NV_Ith_S( y, j )*scale[j];
        j++;
        y_arr[j] = NV_Ith_S( y, j )*scale[j];
        j++;
        y_arr[j] = NV_Ith_S( y, j )*scale[j];
        j++;
        y_arr[j] = NV_Ith_S( y, j )*scale[j];
        j++;
        y_arr[j] = NV_Ith_S( y, j )*scale[j];
        j++;
        y_arr[j] = NV_Ith_S( y, j )*scale[j];
        j++;
        y_arr[j] = NV_Ith_S( y, j )*scale[j];
        j++;
        y_arr[j] = NV_Ith_S( y, j )*scale[j];
        j++;
        y_arr[j] = NV_Ith_S( y, j )*scale[j];
        j++;
        y_arr[j] = NV_Ith_S( y, j )*scale[j];
        j++;
    }

    int flag;
    flag = final__calculate_temperature(data, y_arr , nstrip, nchem );
    if (flag > 0){
        // check if the temperature failed to converged
        return -1;
    }
    final__interpolate_rates(data, nstrip);

    // final__calculate_temperature(data, y_arr, nstrip, nchem);
    // final__interpolate_rates(data, nstrip);

    /* Now We set up some temporaries */

    double *Tge = data->dTs_ge;
    double *k01 = data->rs_k01;
    double *rk01= data->drs_k01;
    double *k02 = data->rs_k02;
    double *rk02= data->drs_k02;
    double *k03 = data->rs_k03;
    double *rk03= data->drs_k03;
    double *k04 = data->rs_k04;
    double *rk04= data->drs_k04;
    double *k05 = data->rs_k05;
    double *rk05= data->drs_k05;
    double *k06 = data->rs_k06;
    double *rk06= data->drs_k06;
    double *k07 = data->rs_k07;
    double *rk07= data->drs_k07;
    double *k08 = data->rs_k08;
    double *rk08= data->drs_k08;
    double *k09 = data->rs_k09;
    double *rk09= data->drs_k09;
    double *k10 = data->rs_k10;
    double *rk10= data->drs_k10;
    double *k11 = data->rs_k11;
    double *rk11= data->drs_k11;
    double *k12 = data->rs_k12;
    double *rk12= data->drs_k12;
    double *k13 = data->rs_k13;
    double *rk13= data->drs_k13;
    double *k14 = data->rs_k14;
    double *rk14= data->drs_k14;
    double *k15 = data->rs_k15;
    double *rk15= data->drs_k15;
    double *k16 = data->rs_k16;
    double *rk16= data->drs_k16;
    double *k17 = data->rs_k17;
    double *rk17= data->drs_k17;
    double *k18 = data->rs_k18;
    double *rk18= data->drs_k18;
    double *k19 = data->rs_k19;
    double *rk19= data->drs_k19;
    double *k21 = data->rs_k21;
    double *rk21= data->drs_k21;
    double *k22 = data->rs_k22;
    double *rk22= data->drs_k22;
    double *brem_brem = data->cs_brem_brem;
    double *rbrem_brem = data->dcs_brem_brem;
    double *ceHeI_ceHeI = data->cs_ceHeI_ceHeI;
    double *rceHeI_ceHeI = data->dcs_ceHeI_ceHeI;
    double *ceHeII_ceHeII = data->cs_ceHeII_ceHeII;
    double *rceHeII_ceHeII = data->dcs_ceHeII_ceHeII;
    double *ceHI_ceHI = data->cs_ceHI_ceHI;
    double *rceHI_ceHI = data->dcs_ceHI_ceHI;
    double *ciHeI_ciHeI = data->cs_ciHeI_ciHeI;
    double *rciHeI_ciHeI = data->dcs_ciHeI_ciHeI;
    double *ciHeII_ciHeII = data->cs_ciHeII_ciHeII;
    double *rciHeII_ciHeII = data->dcs_ciHeII_ciHeII;
    double *ciHeIS_ciHeIS = data->cs_ciHeIS_ciHeIS;
    double *rciHeIS_ciHeIS = data->dcs_ciHeIS_ciHeIS;
    double *ciHI_ciHI = data->cs_ciHI_ciHI;
    double *rciHI_ciHI = data->dcs_ciHI_ciHI;
    double *compton_comp_ = data->cs_compton_comp_;
    double *rcompton_comp_ = data->dcs_compton_comp_;
    double *gammah_gammah = data->cs_gammah_gammah;
    double *rgammah_gammah = data->dcs_gammah_gammah;
    double *gloverabel08_gael = data->cs_gloverabel08_gael;
    double *rgloverabel08_gael = data->dcs_gloverabel08_gael;
    double *gloverabel08_gaH2 = data->cs_gloverabel08_gaH2;
    double *rgloverabel08_gaH2 = data->dcs_gloverabel08_gaH2;
    double *gloverabel08_gaHe = data->cs_gloverabel08_gaHe;
    double *rgloverabel08_gaHe = data->dcs_gloverabel08_gaHe;
    double *gloverabel08_gaHI = data->cs_gloverabel08_gaHI;
    double *rgloverabel08_gaHI = data->dcs_gloverabel08_gaHI;
    double *gloverabel08_gaHp = data->cs_gloverabel08_gaHp;
    double *rgloverabel08_gaHp = data->dcs_gloverabel08_gaHp;
    double *gloverabel08_gphdl = data->cs_gloverabel08_gphdl;
    double *rgloverabel08_gphdl = data->dcs_gloverabel08_gphdl;
    double *gloverabel08_gpldl = data->cs_gloverabel08_gpldl;
    double *rgloverabel08_gpldl = data->dcs_gloverabel08_gpldl;
    double *gloverabel08_h2lte = data->cs_gloverabel08_h2lte;
    double *rgloverabel08_h2lte = data->dcs_gloverabel08_h2lte;
    double *h2formation_h2mcool = data->cs_h2formation_h2mcool;
    double *rh2formation_h2mcool = data->dcs_h2formation_h2mcool;
    double *h2formation_h2mheat = data->cs_h2formation_h2mheat;
    double *rh2formation_h2mheat = data->dcs_h2formation_h2mheat;
    double *h2formation_ncrd1 = data->cs_h2formation_ncrd1;
    double *rh2formation_ncrd1 = data->dcs_h2formation_ncrd1;
    double *h2formation_ncrd2 = data->cs_h2formation_ncrd2;
    double *rh2formation_ncrd2 = data->dcs_h2formation_ncrd2;
    double *h2formation_ncrn = data->cs_h2formation_ncrn;
    double *rh2formation_ncrn = data->dcs_h2formation_ncrn;
    double *reHeII1_reHeII1 = data->cs_reHeII1_reHeII1;
    double *rreHeII1_reHeII1 = data->dcs_reHeII1_reHeII1;
    double *reHeII2_reHeII2 = data->cs_reHeII2_reHeII2;
    double *rreHeII2_reHeII2 = data->dcs_reHeII2_reHeII2;
    double *reHeIII_reHeIII = data->cs_reHeIII_reHeIII;
    double *rreHeIII_reHeIII = data->dcs_reHeIII_reHeIII;
    double *reHII_reHII = data->cs_reHII_reHII;
    double *rreHII_reHII = data->dcs_reHII_reHII;
    double H2_1;
    double H2_2;
    double H_1;
    double H_2;
    double H_m0;
    double He_1;
    double He_2;
    double He_3;
    double de;
    double ge;
    double z;
    double T;

    double mh = 1.67e-24;
    double mdensity, inv_mdensity;

    double scale1, inv_scale2;

    j = 0;
    mdensity = 0.0;
    z = data->current_z;


    for ( i = 0; i < nstrip; i++ ){
        j = i * nchem;
        H2_1 = NV_Ith_S( y, j )*scale[j];
        j++;

        H2_2 = NV_Ith_S( y, j )*scale[j];
        j++;

        H_1 = NV_Ith_S( y, j )*scale[j];
        j++;

        H_2 = NV_Ith_S( y, j )*scale[j];
        j++;

        H_m0 = NV_Ith_S( y, j )*scale[j];
        j++;

        He_1 = NV_Ith_S( y, j )*scale[j];
        j++;

        He_2 = NV_Ith_S( y, j )*scale[j];
        j++;

        He_3 = NV_Ith_S( y, j )*scale[j];
        j++;

        de = NV_Ith_S( y, j )*scale[j];
        j++;

        ge = NV_Ith_S( y, j )*scale[j];
        j++;


        mdensity = data->mdensity[i];
        inv_mdensity = 1.0 / mdensity;

        j = i * nchem;
        //
        // Species: H2_1
        //


        // H2_1 by H2_1

        SM_ELEMENT_D( J, j + 0, j + 0 ) = -k11[i]*H_2 - k12[i]*de - k13[i]*H_1 + k21[i]*H_1*H_1;
        inv_scale2 = inv_scale[ j + 0];
        scale1     = scale    [ j + 0];
        SM_ELEMENT_D( J, j + 0, j + 0) *= inv_scale2*scale1;









        // H2_1 by H2_2

        SM_ELEMENT_D( J, j + 0, j + 1 ) = k10[i]*H_1 + k19[i]*H_m0;
        inv_scale2 = inv_scale[ j + 0];
        scale1     = scale    [ j + 1];
        SM_ELEMENT_D( J, j + 0, j + 1) *= inv_scale2*scale1;









        // H2_1 by H_1

        SM_ELEMENT_D( J, j + 0, j + 2 ) = k08[i]*H_m0 + k10[i]*H2_2 - k13[i]*H2_1;
        inv_scale2 = inv_scale[ j + 0];
        scale1     = scale    [ j + 2];
        SM_ELEMENT_D( J, j + 0, j + 2) *= inv_scale2*scale1;









        // H2_1 by H_2

        SM_ELEMENT_D( J, j + 0, j + 3 ) = -k11[i]*H2_1;
        inv_scale2 = inv_scale[ j + 0];
        scale1     = scale    [ j + 3];
        SM_ELEMENT_D( J, j + 0, j + 3) *= inv_scale2*scale1;









        // H2_1 by H_m0

        SM_ELEMENT_D( J, j + 0, j + 4 ) = k08[i]*H_1 + k19[i]*H2_2;
        inv_scale2 = inv_scale[ j + 0];
        scale1     = scale    [ j + 4];
        SM_ELEMENT_D( J, j + 0, j + 4) *= inv_scale2*scale1;









        // H2_1 by He_1

        // because the Jacobian is initialized to zeros by default
        // SM_ELEMENT_D( J, j + 0, j + 5 ) = 0;








        // H2_1 by He_2

        // because the Jacobian is initialized to zeros by default
        // SM_ELEMENT_D( J, j + 0, j + 6 ) = 0;








        // H2_1 by He_3

        // because the Jacobian is initialized to zeros by default
        // SM_ELEMENT_D( J, j + 0, j + 7 ) = 0;








        // H2_1 by de

        SM_ELEMENT_D( J, j + 0, j + 8 ) = -k12[i]*H2_1;
        inv_scale2 = inv_scale[ j + 0];
        scale1     = scale    [ j + 8];
        SM_ELEMENT_D( J, j + 0, j + 8) *= inv_scale2*scale1;









        // H2_1 by ge

        SM_ELEMENT_D( J, j + 0, j + 9 ) = rk08[i]*H_1*H_m0 + rk10[i]*H2_2*H_1 - rk11[i]*H2_1*H_2 - rk12[i]*H2_1*de - rk13[i]*H2_1*H_1 + rk19[i]*H2_2*H_m0 + rk21[i]*H2_1*H_1*H_1 + rk22[i]*H_1*H_1*H_1;
        inv_scale2 = inv_scale[ j + 0];
        scale1     = scale    [ j + 9];
        SM_ELEMENT_D( J, j + 0, j + 9) *= inv_scale2*scale1;








        SM_ELEMENT_D( J, j + 0, j + 9 ) *= Tge[i];


        //
        // Species: H2_2
        //


        // H2_2 by H2_1

        SM_ELEMENT_D( J, j + 1, j + 0 ) = k11[i]*H_2;
        inv_scale2 = inv_scale[ j + 1];
        scale1     = scale    [ j + 0];
        SM_ELEMENT_D( J, j + 1, j + 0) *= inv_scale2*scale1;









        // H2_2 by H2_2

        SM_ELEMENT_D( J, j + 1, j + 1 ) = -k10[i]*H_1 - k18[i]*de - k19[i]*H_m0;
        inv_scale2 = inv_scale[ j + 1];
        scale1     = scale    [ j + 1];
        SM_ELEMENT_D( J, j + 1, j + 1) *= inv_scale2*scale1;









        // H2_2 by H_1

        SM_ELEMENT_D( J, j + 1, j + 2 ) = k09[i]*H_2 - k10[i]*H2_2;
        inv_scale2 = inv_scale[ j + 1];
        scale1     = scale    [ j + 2];
        SM_ELEMENT_D( J, j + 1, j + 2) *= inv_scale2*scale1;









        // H2_2 by H_2

        SM_ELEMENT_D( J, j + 1, j + 3 ) = k09[i]*H_1 + k11[i]*H2_1 + k17[i]*H_m0;
        inv_scale2 = inv_scale[ j + 1];
        scale1     = scale    [ j + 3];
        SM_ELEMENT_D( J, j + 1, j + 3) *= inv_scale2*scale1;









        // H2_2 by H_m0

        SM_ELEMENT_D( J, j + 1, j + 4 ) = k17[i]*H_2 - k19[i]*H2_2;
        inv_scale2 = inv_scale[ j + 1];
        scale1     = scale    [ j + 4];
        SM_ELEMENT_D( J, j + 1, j + 4) *= inv_scale2*scale1;









        // H2_2 by He_1

        // because the Jacobian is initialized to zeros by default
        // SM_ELEMENT_D( J, j + 1, j + 5 ) = 0;








        // H2_2 by He_2

        // because the Jacobian is initialized to zeros by default
        // SM_ELEMENT_D( J, j + 1, j + 6 ) = 0;








        // H2_2 by He_3

        // because the Jacobian is initialized to zeros by default
        // SM_ELEMENT_D( J, j + 1, j + 7 ) = 0;








        // H2_2 by de

        SM_ELEMENT_D( J, j + 1, j + 8 ) = -k18[i]*H2_2;
        inv_scale2 = inv_scale[ j + 1];
        scale1     = scale    [ j + 8];
        SM_ELEMENT_D( J, j + 1, j + 8) *= inv_scale2*scale1;









        // H2_2 by ge

        SM_ELEMENT_D( J, j + 1, j + 9 ) = rk09[i]*H_1*H_2 - rk10[i]*H2_2*H_1 + rk11[i]*H2_1*H_2 + rk17[i]*H_2*H_m0 - rk18[i]*H2_2*de - rk19[i]*H2_2*H_m0;
        inv_scale2 = inv_scale[ j + 1];
        scale1     = scale    [ j + 9];
        SM_ELEMENT_D( J, j + 1, j + 9) *= inv_scale2*scale1;








        SM_ELEMENT_D( J, j + 1, j + 9 ) *= Tge[i];


        //
        // Species: H_1
        //


        // H_1 by H2_1

        SM_ELEMENT_D( J, j + 2, j + 0 ) = k11[i]*H_2 + 2*k12[i]*de + 2*k13[i]*H_1 - 2*k21[i]*H_1*H_1;
        inv_scale2 = inv_scale[ j + 2];
        scale1     = scale    [ j + 0];
        SM_ELEMENT_D( J, j + 2, j + 0) *= inv_scale2*scale1;









        // H_1 by H2_2

        SM_ELEMENT_D( J, j + 2, j + 1 ) = -k10[i]*H_1 + 2*k18[i]*de + k19[i]*H_m0;
        inv_scale2 = inv_scale[ j + 2];
        scale1     = scale    [ j + 1];
        SM_ELEMENT_D( J, j + 2, j + 1) *= inv_scale2*scale1;









        // H_1 by H_1

        SM_ELEMENT_D( J, j + 2, j + 2 ) = -k01[i]*de - k07[i]*de - k08[i]*H_m0 - k09[i]*H_2 - k10[i]*H2_2 + 2*k13[i]*H2_1 + k15[i]*H_m0;
        inv_scale2 = inv_scale[ j + 2];
        scale1     = scale    [ j + 2];
        SM_ELEMENT_D( J, j + 2, j + 2) *= inv_scale2*scale1;









        // H_1 by H_2

        SM_ELEMENT_D( J, j + 2, j + 3 ) = k02[i]*de - k09[i]*H_1 + k11[i]*H2_1 + 2*k16[i]*H_m0;
        inv_scale2 = inv_scale[ j + 2];
        scale1     = scale    [ j + 3];
        SM_ELEMENT_D( J, j + 2, j + 3) *= inv_scale2*scale1;









        // H_1 by H_m0

        SM_ELEMENT_D( J, j + 2, j + 4 ) = -k08[i]*H_1 + k14[i]*de + k15[i]*H_1 + 2*k16[i]*H_2 + k19[i]*H2_2;
        inv_scale2 = inv_scale[ j + 2];
        scale1     = scale    [ j + 4];
        SM_ELEMENT_D( J, j + 2, j + 4) *= inv_scale2*scale1;









        // H_1 by He_1

        // because the Jacobian is initialized to zeros by default
        // SM_ELEMENT_D( J, j + 2, j + 5 ) = 0;








        // H_1 by He_2

        // because the Jacobian is initialized to zeros by default
        // SM_ELEMENT_D( J, j + 2, j + 6 ) = 0;








        // H_1 by He_3

        // because the Jacobian is initialized to zeros by default
        // SM_ELEMENT_D( J, j + 2, j + 7 ) = 0;








        // H_1 by de

        SM_ELEMENT_D( J, j + 2, j + 8 ) = -k01[i]*H_1 + k02[i]*H_2 - k07[i]*H_1 + 2*k12[i]*H2_1 + k14[i]*H_m0 + 2*k18[i]*H2_2;
        inv_scale2 = inv_scale[ j + 2];
        scale1     = scale    [ j + 8];
        SM_ELEMENT_D( J, j + 2, j + 8) *= inv_scale2*scale1;









        // H_1 by ge

        SM_ELEMENT_D( J, j + 2, j + 9 ) = -rk01[i]*H_1*de + rk02[i]*H_2*de - rk07[i]*H_1*de - rk08[i]*H_1*H_m0 - rk09[i]*H_1*H_2 - rk10[i]*H2_2*H_1 + rk11[i]*H2_1*H_2 + 2*rk12[i]*H2_1*de + 2*rk13[i]*H2_1*H_1 + rk14[i]*H_m0*de + rk15[i]*H_1*H_m0 + 2*rk16[i]*H_2*H_m0 + 2*rk18[i]*H2_2*de + rk19[i]*H2_2*H_m0 - 2*rk21[i]*H2_1*H_1*H_1 - 2*rk22[i]*H_1*H_1*H_1;
        inv_scale2 = inv_scale[ j + 2];
        scale1     = scale    [ j + 9];
        SM_ELEMENT_D( J, j + 2, j + 9) *= inv_scale2*scale1;








        SM_ELEMENT_D( J, j + 2, j + 9 ) *= Tge[i];


        //
        // Species: H_2
        //


        // H_2 by H2_1

        SM_ELEMENT_D( J, j + 3, j + 0 ) = -k11[i]*H_2;
        inv_scale2 = inv_scale[ j + 3];
        scale1     = scale    [ j + 0];
        SM_ELEMENT_D( J, j + 3, j + 0) *= inv_scale2*scale1;









        // H_2 by H2_2

        SM_ELEMENT_D( J, j + 3, j + 1 ) = k10[i]*H_1;
        inv_scale2 = inv_scale[ j + 3];
        scale1     = scale    [ j + 1];
        SM_ELEMENT_D( J, j + 3, j + 1) *= inv_scale2*scale1;









        // H_2 by H_1

        SM_ELEMENT_D( J, j + 3, j + 2 ) = k01[i]*de - k09[i]*H_2 + k10[i]*H2_2;
        inv_scale2 = inv_scale[ j + 3];
        scale1     = scale    [ j + 2];
        SM_ELEMENT_D( J, j + 3, j + 2) *= inv_scale2*scale1;









        // H_2 by H_2

        SM_ELEMENT_D( J, j + 3, j + 3 ) = -k02[i]*de - k09[i]*H_1 - k11[i]*H2_1 - k16[i]*H_m0 - k17[i]*H_m0;
        inv_scale2 = inv_scale[ j + 3];
        scale1     = scale    [ j + 3];
        SM_ELEMENT_D( J, j + 3, j + 3) *= inv_scale2*scale1;









        // H_2 by H_m0

        SM_ELEMENT_D( J, j + 3, j + 4 ) = -k16[i]*H_2 - k17[i]*H_2;
        inv_scale2 = inv_scale[ j + 3];
        scale1     = scale    [ j + 4];
        SM_ELEMENT_D( J, j + 3, j + 4) *= inv_scale2*scale1;









        // H_2 by He_1

        // because the Jacobian is initialized to zeros by default
        // SM_ELEMENT_D( J, j + 3, j + 5 ) = 0;








        // H_2 by He_2

        // because the Jacobian is initialized to zeros by default
        // SM_ELEMENT_D( J, j + 3, j + 6 ) = 0;








        // H_2 by He_3

        // because the Jacobian is initialized to zeros by default
        // SM_ELEMENT_D( J, j + 3, j + 7 ) = 0;








        // H_2 by de

        SM_ELEMENT_D( J, j + 3, j + 8 ) = k01[i]*H_1 - k02[i]*H_2;
        inv_scale2 = inv_scale[ j + 3];
        scale1     = scale    [ j + 8];
        SM_ELEMENT_D( J, j + 3, j + 8) *= inv_scale2*scale1;









        // H_2 by ge

        SM_ELEMENT_D( J, j + 3, j + 9 ) = rk01[i]*H_1*de - rk02[i]*H_2*de - rk09[i]*H_1*H_2 + rk10[i]*H2_2*H_1 - rk11[i]*H2_1*H_2 - rk16[i]*H_2*H_m0 - rk17[i]*H_2*H_m0;
        inv_scale2 = inv_scale[ j + 3];
        scale1     = scale    [ j + 9];
        SM_ELEMENT_D( J, j + 3, j + 9) *= inv_scale2*scale1;








        SM_ELEMENT_D( J, j + 3, j + 9 ) *= Tge[i];


        //
        // Species: H_m0
        //


        // H_m0 by H2_1

        // because the Jacobian is initialized to zeros by default
        // SM_ELEMENT_D( J, j + 4, j + 0 ) = 0;








        // H_m0 by H2_2

        SM_ELEMENT_D( J, j + 4, j + 1 ) = -k19[i]*H_m0;
        inv_scale2 = inv_scale[ j + 4];
        scale1     = scale    [ j + 1];
        SM_ELEMENT_D( J, j + 4, j + 1) *= inv_scale2*scale1;









        // H_m0 by H_1

        SM_ELEMENT_D( J, j + 4, j + 2 ) = k07[i]*de - k08[i]*H_m0 - k15[i]*H_m0;
        inv_scale2 = inv_scale[ j + 4];
        scale1     = scale    [ j + 2];
        SM_ELEMENT_D( J, j + 4, j + 2) *= inv_scale2*scale1;









        // H_m0 by H_2

        SM_ELEMENT_D( J, j + 4, j + 3 ) = -k16[i]*H_m0 - k17[i]*H_m0;
        inv_scale2 = inv_scale[ j + 4];
        scale1     = scale    [ j + 3];
        SM_ELEMENT_D( J, j + 4, j + 3) *= inv_scale2*scale1;









        // H_m0 by H_m0

        SM_ELEMENT_D( J, j + 4, j + 4 ) = -k08[i]*H_1 - k14[i]*de - k15[i]*H_1 - k16[i]*H_2 - k17[i]*H_2 - k19[i]*H2_2;
        inv_scale2 = inv_scale[ j + 4];
        scale1     = scale    [ j + 4];
        SM_ELEMENT_D( J, j + 4, j + 4) *= inv_scale2*scale1;









        // H_m0 by He_1

        // because the Jacobian is initialized to zeros by default
        // SM_ELEMENT_D( J, j + 4, j + 5 ) = 0;








        // H_m0 by He_2

        // because the Jacobian is initialized to zeros by default
        // SM_ELEMENT_D( J, j + 4, j + 6 ) = 0;








        // H_m0 by He_3

        // because the Jacobian is initialized to zeros by default
        // SM_ELEMENT_D( J, j + 4, j + 7 ) = 0;








        // H_m0 by de

        SM_ELEMENT_D( J, j + 4, j + 8 ) = k07[i]*H_1 - k14[i]*H_m0;
        inv_scale2 = inv_scale[ j + 4];
        scale1     = scale    [ j + 8];
        SM_ELEMENT_D( J, j + 4, j + 8) *= inv_scale2*scale1;









        // H_m0 by ge

        SM_ELEMENT_D( J, j + 4, j + 9 ) = rk07[i]*H_1*de - rk08[i]*H_1*H_m0 - rk14[i]*H_m0*de - rk15[i]*H_1*H_m0 - rk16[i]*H_2*H_m0 - rk17[i]*H_2*H_m0 - rk19[i]*H2_2*H_m0;
        inv_scale2 = inv_scale[ j + 4];
        scale1     = scale    [ j + 9];
        SM_ELEMENT_D( J, j + 4, j + 9) *= inv_scale2*scale1;








        SM_ELEMENT_D( J, j + 4, j + 9 ) *= Tge[i];


        //
        // Species: He_1
        //


        // He_1 by H2_1

        // because the Jacobian is initialized to zeros by default
        // SM_ELEMENT_D( J, j + 5, j + 0 ) = 0;








        // He_1 by H2_2

        // because the Jacobian is initialized to zeros by default
        // SM_ELEMENT_D( J, j + 5, j + 1 ) = 0;








        // He_1 by H_1

        // because the Jacobian is initialized to zeros by default
        // SM_ELEMENT_D( J, j + 5, j + 2 ) = 0;








        // He_1 by H_2

        // because the Jacobian is initialized to zeros by default
        // SM_ELEMENT_D( J, j + 5, j + 3 ) = 0;








        // He_1 by H_m0

        // because the Jacobian is initialized to zeros by default
        // SM_ELEMENT_D( J, j + 5, j + 4 ) = 0;








        // He_1 by He_1

        SM_ELEMENT_D( J, j + 5, j + 5 ) = -k03[i]*de;
        inv_scale2 = inv_scale[ j + 5];
        scale1     = scale    [ j + 5];
        SM_ELEMENT_D( J, j + 5, j + 5) *= inv_scale2*scale1;









        // He_1 by He_2

        SM_ELEMENT_D( J, j + 5, j + 6 ) = k04[i]*de;
        inv_scale2 = inv_scale[ j + 5];
        scale1     = scale    [ j + 6];
        SM_ELEMENT_D( J, j + 5, j + 6) *= inv_scale2*scale1;









        // He_1 by He_3

        // because the Jacobian is initialized to zeros by default
        // SM_ELEMENT_D( J, j + 5, j + 7 ) = 0;








        // He_1 by de

        SM_ELEMENT_D( J, j + 5, j + 8 ) = -k03[i]*He_1 + k04[i]*He_2;
        inv_scale2 = inv_scale[ j + 5];
        scale1     = scale    [ j + 8];
        SM_ELEMENT_D( J, j + 5, j + 8) *= inv_scale2*scale1;









        // He_1 by ge

        SM_ELEMENT_D( J, j + 5, j + 9 ) = -rk03[i]*He_1*de + rk04[i]*He_2*de;
        inv_scale2 = inv_scale[ j + 5];
        scale1     = scale    [ j + 9];
        SM_ELEMENT_D( J, j + 5, j + 9) *= inv_scale2*scale1;








        SM_ELEMENT_D( J, j + 5, j + 9 ) *= Tge[i];


        //
        // Species: He_2
        //


        // He_2 by H2_1

        // because the Jacobian is initialized to zeros by default
        // SM_ELEMENT_D( J, j + 6, j + 0 ) = 0;








        // He_2 by H2_2

        // because the Jacobian is initialized to zeros by default
        // SM_ELEMENT_D( J, j + 6, j + 1 ) = 0;








        // He_2 by H_1

        // because the Jacobian is initialized to zeros by default
        // SM_ELEMENT_D( J, j + 6, j + 2 ) = 0;








        // He_2 by H_2

        // because the Jacobian is initialized to zeros by default
        // SM_ELEMENT_D( J, j + 6, j + 3 ) = 0;








        // He_2 by H_m0

        // because the Jacobian is initialized to zeros by default
        // SM_ELEMENT_D( J, j + 6, j + 4 ) = 0;








        // He_2 by He_1

        SM_ELEMENT_D( J, j + 6, j + 5 ) = k03[i]*de;
        inv_scale2 = inv_scale[ j + 6];
        scale1     = scale    [ j + 5];
        SM_ELEMENT_D( J, j + 6, j + 5) *= inv_scale2*scale1;









        // He_2 by He_2

        SM_ELEMENT_D( J, j + 6, j + 6 ) = -k04[i]*de - k05[i]*de;
        inv_scale2 = inv_scale[ j + 6];
        scale1     = scale    [ j + 6];
        SM_ELEMENT_D( J, j + 6, j + 6) *= inv_scale2*scale1;









        // He_2 by He_3

        SM_ELEMENT_D( J, j + 6, j + 7 ) = k06[i]*de;
        inv_scale2 = inv_scale[ j + 6];
        scale1     = scale    [ j + 7];
        SM_ELEMENT_D( J, j + 6, j + 7) *= inv_scale2*scale1;









        // He_2 by de

        SM_ELEMENT_D( J, j + 6, j + 8 ) = k03[i]*He_1 - k04[i]*He_2 - k05[i]*He_2 + k06[i]*He_3;
        inv_scale2 = inv_scale[ j + 6];
        scale1     = scale    [ j + 8];
        SM_ELEMENT_D( J, j + 6, j + 8) *= inv_scale2*scale1;









        // He_2 by ge

        SM_ELEMENT_D( J, j + 6, j + 9 ) = rk03[i]*He_1*de - rk04[i]*He_2*de - rk05[i]*He_2*de + rk06[i]*He_3*de;
        inv_scale2 = inv_scale[ j + 6];
        scale1     = scale    [ j + 9];
        SM_ELEMENT_D( J, j + 6, j + 9) *= inv_scale2*scale1;








        SM_ELEMENT_D( J, j + 6, j + 9 ) *= Tge[i];


        //
        // Species: He_3
        //


        // He_3 by H2_1

        // because the Jacobian is initialized to zeros by default
        // SM_ELEMENT_D( J, j + 7, j + 0 ) = 0;








        // He_3 by H2_2

        // because the Jacobian is initialized to zeros by default
        // SM_ELEMENT_D( J, j + 7, j + 1 ) = 0;








        // He_3 by H_1

        // because the Jacobian is initialized to zeros by default
        // SM_ELEMENT_D( J, j + 7, j + 2 ) = 0;








        // He_3 by H_2

        // because the Jacobian is initialized to zeros by default
        // SM_ELEMENT_D( J, j + 7, j + 3 ) = 0;








        // He_3 by H_m0

        // because the Jacobian is initialized to zeros by default
        // SM_ELEMENT_D( J, j + 7, j + 4 ) = 0;








        // He_3 by He_1

        // because the Jacobian is initialized to zeros by default
        // SM_ELEMENT_D( J, j + 7, j + 5 ) = 0;








        // He_3 by He_2

        SM_ELEMENT_D( J, j + 7, j + 6 ) = k05[i]*de;
        inv_scale2 = inv_scale[ j + 7];
        scale1     = scale    [ j + 6];
        SM_ELEMENT_D( J, j + 7, j + 6) *= inv_scale2*scale1;









        // He_3 by He_3

        SM_ELEMENT_D( J, j + 7, j + 7 ) = -k06[i]*de;
        inv_scale2 = inv_scale[ j + 7];
        scale1     = scale    [ j + 7];
        SM_ELEMENT_D( J, j + 7, j + 7) *= inv_scale2*scale1;









        // He_3 by de

        SM_ELEMENT_D( J, j + 7, j + 8 ) = k05[i]*He_2 - k06[i]*He_3;
        inv_scale2 = inv_scale[ j + 7];
        scale1     = scale    [ j + 8];
        SM_ELEMENT_D( J, j + 7, j + 8) *= inv_scale2*scale1;









        // He_3 by ge

        SM_ELEMENT_D( J, j + 7, j + 9 ) = rk05[i]*He_2*de - rk06[i]*He_3*de;
        inv_scale2 = inv_scale[ j + 7];
        scale1     = scale    [ j + 9];
        SM_ELEMENT_D( J, j + 7, j + 9) *= inv_scale2*scale1;








        SM_ELEMENT_D( J, j + 7, j + 9 ) *= Tge[i];


        //
        // Species: de
        //


        // de by H2_1

        // because the Jacobian is initialized to zeros by default
        // SM_ELEMENT_D( J, j + 8, j + 0 ) = 0;








        // de by H2_2

        SM_ELEMENT_D( J, j + 8, j + 1 ) = -k18[i]*de;
        inv_scale2 = inv_scale[ j + 8];
        scale1     = scale    [ j + 1];
        SM_ELEMENT_D( J, j + 8, j + 1) *= inv_scale2*scale1;









        // de by H_1

        SM_ELEMENT_D( J, j + 8, j + 2 ) = k01[i]*de - k07[i]*de + k08[i]*H_m0 + k15[i]*H_m0;
        inv_scale2 = inv_scale[ j + 8];
        scale1     = scale    [ j + 2];
        SM_ELEMENT_D( J, j + 8, j + 2) *= inv_scale2*scale1;









        // de by H_2

        SM_ELEMENT_D( J, j + 8, j + 3 ) = -k02[i]*de + k17[i]*H_m0;
        inv_scale2 = inv_scale[ j + 8];
        scale1     = scale    [ j + 3];
        SM_ELEMENT_D( J, j + 8, j + 3) *= inv_scale2*scale1;









        // de by H_m0

        SM_ELEMENT_D( J, j + 8, j + 4 ) = k08[i]*H_1 + k14[i]*de + k15[i]*H_1 + k17[i]*H_2;
        inv_scale2 = inv_scale[ j + 8];
        scale1     = scale    [ j + 4];
        SM_ELEMENT_D( J, j + 8, j + 4) *= inv_scale2*scale1;









        // de by He_1

        SM_ELEMENT_D( J, j + 8, j + 5 ) = k03[i]*de;
        inv_scale2 = inv_scale[ j + 8];
        scale1     = scale    [ j + 5];
        SM_ELEMENT_D( J, j + 8, j + 5) *= inv_scale2*scale1;









        // de by He_2

        SM_ELEMENT_D( J, j + 8, j + 6 ) = -k04[i]*de + k05[i]*de;
        inv_scale2 = inv_scale[ j + 8];
        scale1     = scale    [ j + 6];
        SM_ELEMENT_D( J, j + 8, j + 6) *= inv_scale2*scale1;









        // de by He_3

        SM_ELEMENT_D( J, j + 8, j + 7 ) = -k06[i]*de;
        inv_scale2 = inv_scale[ j + 8];
        scale1     = scale    [ j + 7];
        SM_ELEMENT_D( J, j + 8, j + 7) *= inv_scale2*scale1;









        // de by de

        SM_ELEMENT_D( J, j + 8, j + 8 ) = k01[i]*H_1 - k02[i]*H_2 + k03[i]*He_1 - k04[i]*He_2 + k05[i]*He_2 - k06[i]*He_3 - k07[i]*H_1 + k14[i]*H_m0 - k18[i]*H2_2;
        inv_scale2 = inv_scale[ j + 8];
        scale1     = scale    [ j + 8];
        SM_ELEMENT_D( J, j + 8, j + 8) *= inv_scale2*scale1;









        // de by ge

        SM_ELEMENT_D( J, j + 8, j + 9 ) = rk01[i]*H_1*de - rk02[i]*H_2*de + rk03[i]*He_1*de - rk04[i]*He_2*de + rk05[i]*He_2*de - rk06[i]*He_3*de - rk07[i]*H_1*de + rk08[i]*H_1*H_m0 + rk14[i]*H_m0*de + rk15[i]*H_1*H_m0 + rk17[i]*H_2*H_m0 - rk18[i]*H2_2*de;
        inv_scale2 = inv_scale[ j + 8];
        scale1     = scale    [ j + 9];
        SM_ELEMENT_D( J, j + 8, j + 9) *= inv_scale2*scale1;








        SM_ELEMENT_D( J, j + 8, j + 9 ) *= Tge[i];


        //
        // Species: ge
        //


        // ge by H2_1

        SM_ELEMENT_D( J, j + 9, j + 0 ) = (-H2_1*gloverabel08_gaH2[i]*pow(gloverabel08_h2lte[i], 2)/(pow(gloverabel08_h2lte[i]/(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i]) + 1.0, 2)*pow(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i], 2)) - 0.5*H_1*h2formation_h2mcool[i]*1.0/(h2formation_ncrn[i]/(H2_1*h2formation_ncrd2[i] + H_1*h2formation_ncrd1[i]) + 1.0) - gloverabel08_h2lte[i]/(gloverabel08_h2lte[i]/(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i]) + 1.0) + 0.5*h2formation_ncrd2[i]*h2formation_ncrn[i]*pow(h2formation_ncrn[i]/(H2_1*h2formation_ncrd2[i] + H_1*h2formation_ncrd1[i]) + 1.0, -2.0)*(-H2_1*H_1*h2formation_h2mcool[i] + pow(H_1, 3)*h2formation_h2mheat[i])/pow(H2_1*h2formation_ncrd2[i] + H_1*h2formation_ncrd1[i], 2))*fmin(1.00000000000000, (1.0 - exp(-fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8))))/fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8)));
        inv_scale2 = inv_scale[ j + 9];
        scale1     = scale    [ j + 0];
        SM_ELEMENT_D( J, j + 9, j + 0) *= inv_scale2*scale1;







        SM_ELEMENT_D( J, j + 9, j + 0 ) *= inv_mdensity;



        // ge by H2_2

        // because the Jacobian is initialized to zeros by default
        // SM_ELEMENT_D( J, j + 9, j + 1 ) = 0;






        SM_ELEMENT_D( J, j + 9, j + 1 ) *= inv_mdensity;



        // ge by H_1

        SM_ELEMENT_D( J, j + 9, j + 2 ) = (-H2_1*gloverabel08_gaHI[i]*pow(gloverabel08_h2lte[i], 2)/(pow(gloverabel08_h2lte[i]/(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i]) + 1.0, 2)*pow(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i], 2)) - ceHI_ceHI[i]*de - ciHI_ciHI[i]*de + 0.5*h2formation_ncrd1[i]*h2formation_ncrn[i]*pow(h2formation_ncrn[i]/(H2_1*h2formation_ncrd2[i] + H_1*h2formation_ncrd1[i]) + 1.0, -2.0)*(-H2_1*H_1*h2formation_h2mcool[i] + pow(H_1, 3)*h2formation_h2mheat[i])/pow(H2_1*h2formation_ncrd2[i] + H_1*h2formation_ncrd1[i], 2) + 0.5*(-H2_1*h2formation_h2mcool[i] + 3*pow(H_1, 2)*h2formation_h2mheat[i])*1.0/(h2formation_ncrn[i]/(H2_1*h2formation_ncrd2[i] + H_1*h2formation_ncrd1[i]) + 1.0))*fmin(1.00000000000000, (1.0 - exp(-fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8))))/fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8)));
        inv_scale2 = inv_scale[ j + 9];
        scale1     = scale    [ j + 2];
        SM_ELEMENT_D( J, j + 9, j + 2) *= inv_scale2*scale1;







        SM_ELEMENT_D( J, j + 9, j + 2 ) *= inv_mdensity;



        // ge by H_2

        SM_ELEMENT_D( J, j + 9, j + 3 ) = (-H2_1*gloverabel08_gaHp[i]*pow(gloverabel08_h2lte[i], 2)/(pow(gloverabel08_h2lte[i]/(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i]) + 1.0, 2)*pow(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i], 2)) - brem_brem[i]*de - de*reHII_reHII[i])*fmin(1.00000000000000, (1.0 - exp(-fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8))))/fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8)));
        inv_scale2 = inv_scale[ j + 9];
        scale1     = scale    [ j + 3];
        SM_ELEMENT_D( J, j + 9, j + 3) *= inv_scale2*scale1;







        SM_ELEMENT_D( J, j + 9, j + 3 ) *= inv_mdensity;



        // ge by H_m0

        // because the Jacobian is initialized to zeros by default
        // SM_ELEMENT_D( J, j + 9, j + 4 ) = 0;






        SM_ELEMENT_D( J, j + 9, j + 4 ) *= inv_mdensity;



        // ge by He_1

        SM_ELEMENT_D( J, j + 9, j + 5 ) = (-H2_1*gloverabel08_gaHe[i]*pow(gloverabel08_h2lte[i], 2)/(pow(gloverabel08_h2lte[i]/(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i]) + 1.0, 2)*pow(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i], 2)) - ciHeI_ciHeI[i]*de)*fmin(1.00000000000000, (1.0 - exp(-fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8))))/fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8)));
        inv_scale2 = inv_scale[ j + 9];
        scale1     = scale    [ j + 5];
        SM_ELEMENT_D( J, j + 9, j + 5) *= inv_scale2*scale1;







        SM_ELEMENT_D( J, j + 9, j + 5 ) *= inv_mdensity;



        // ge by He_2

        SM_ELEMENT_D( J, j + 9, j + 6 ) = (-brem_brem[i]*de - ceHeII_ceHeII[i]*de - ceHeI_ceHeI[i]*pow(de, 2) - ciHeII_ciHeII[i]*de - ciHeIS_ciHeIS[i]*pow(de, 2) - de*reHeII1_reHeII1[i] - de*reHeII2_reHeII2[i])*fmin(1.00000000000000, (1.0 - exp(-fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8))))/fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8)));
        inv_scale2 = inv_scale[ j + 9];
        scale1     = scale    [ j + 6];
        SM_ELEMENT_D( J, j + 9, j + 6) *= inv_scale2*scale1;







        SM_ELEMENT_D( J, j + 9, j + 6 ) *= inv_mdensity;



        // ge by He_3

        SM_ELEMENT_D( J, j + 9, j + 7 ) = (-4.0*brem_brem[i]*de - de*reHeIII_reHeIII[i])*fmin(1.00000000000000, (1.0 - exp(-fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8))))/fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8)));
        inv_scale2 = inv_scale[ j + 9];
        scale1     = scale    [ j + 7];
        SM_ELEMENT_D( J, j + 9, j + 7) *= inv_scale2*scale1;







        SM_ELEMENT_D( J, j + 9, j + 7 ) *= inv_mdensity;



        // ge by de

        SM_ELEMENT_D( J, j + 9, j + 8 ) = (-H2_1*gloverabel08_gael[i]*pow(gloverabel08_h2lte[i], 2)/(pow(gloverabel08_h2lte[i]/(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i]) + 1.0, 2)*pow(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i], 2)) - H_1*ceHI_ceHI[i] - H_1*ciHI_ciHI[i] - H_2*reHII_reHII[i] - He_1*ciHeI_ciHeI[i] - He_2*ceHeII_ceHeII[i] - 2*He_2*ceHeI_ceHeI[i]*de - He_2*ciHeII_ciHeII[i] - 2*He_2*ciHeIS_ciHeIS[i]*de - He_2*reHeII1_reHeII1[i] - He_2*reHeII2_reHeII2[i] - He_3*reHeIII_reHeIII[i] - brem_brem[i]*(H_2 + He_2 + 4.0*He_3) - compton_comp_[i]*pow(z + 1.0, 4)*(T - 2.73*z - 2.73))*fmin(1.00000000000000, (1.0 - exp(-fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8))))/fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8)));
        inv_scale2 = inv_scale[ j + 9];
        scale1     = scale    [ j + 8];
        SM_ELEMENT_D( J, j + 9, j + 8) *= inv_scale2*scale1;







        SM_ELEMENT_D( J, j + 9, j + 8 ) *= inv_mdensity;



        // ge by ge

        SM_ELEMENT_D( J, j + 9, j + 9 ) = (-H2_1*gloverabel08_h2lte[i]/(gloverabel08_h2lte[i]/(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i]) + 1.0) - H_1*ceHI_ceHI[i]*de - H_1*ciHI_ciHI[i]*de - H_2*de*reHII_reHII[i] - He_1*ciHeI_ciHeI[i]*de - He_2*ceHeII_ceHeII[i]*de - He_2*ceHeI_ceHeI[i]*pow(de, 2) - He_2*ciHeII_ciHeII[i]*de - He_2*ciHeIS_ciHeIS[i]*pow(de, 2) - He_2*de*reHeII1_reHeII1[i] - He_2*de*reHeII2_reHeII2[i] - He_3*de*reHeIII_reHeIII[i] - brem_brem[i]*de*(H_2 + He_2 + 4.0*He_3) - compton_comp_[i]*de*pow(z + 1.0, 4)*(T - 2.73*z - 2.73) + 0.5*1.0/(h2formation_ncrn[i]/(H2_1*h2formation_ncrd2[i] + H_1*h2formation_ncrd1[i]) + 1.0)*(-H2_1*H_1*h2formation_h2mcool[i] + pow(H_1, 3)*h2formation_h2mheat[i]))*fmin(1.00000000000000, (1.0 - exp(-fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8))))/fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8)));
        inv_scale2 = inv_scale[ j + 9];
        scale1     = scale    [ j + 9];
        SM_ELEMENT_D( J, j + 9, j + 9) *= inv_scale2*scale1;





        // ad-hoc extra term of f_ge by ge
        // considering ONLY the h2formation/ and continuum cooling
        SM_ELEMENT_D( J, j + 9, j + 9 ) =  -H2_1*gloverabel08_h2lte[i]*(-gloverabel08_h2lte[i]*(-H2_1*rgloverabel08_gaH2[i] - H_1*rgloverabel08_gaHI[i] - H_2*rgloverabel08_gaHp[i] - He_1*rgloverabel08_gaHe[i] - de*rgloverabel08_gael[i])/pow(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i], 2) - rgloverabel08_h2lte[i]/(H2_1*gloverabel08_gaH2[i] +
        H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i]))/pow(gloverabel08_h2lte[i]/(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i]) + 1.0, 2) - H2_1*rgloverabel08_h2lte[i]/(gloverabel08_h2lte[i]/(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] +
        de*gloverabel08_gael[i]) + 1.0) - compton_comp_[i]*de*pow(z + 1.0, 4) + 0.5*pow(h2formation_ncrn[i]/(H2_1*h2formation_ncrd2[i] + H_1*h2formation_ncrd1[i]) + 1.0, -2.0)*(-H2_1*H_1*h2formation_h2mcool[i] + pow(H_1, 3)*h2formation_h2mheat[i])*(-1.0*h2formation_ncrn[i]*(-H2_1*rh2formation_ncrd2[i] - H_1*rh2formation_ncrd1[i])/pow(H2_1*h2formation_ncrd2[i] + H_1*h2formation_ncrd1[i], 2) - 1.0*rh2formation_ncrn[i]/(H2_1*h2formation_ncrd2[i] +
        H_1*h2formation_ncrd1[i])) + 0.5*1.0/(h2formation_ncrn[i]/(H2_1*h2formation_ncrd2[i] + H_1*h2formation_ncrd1[i]) + 1.0)*(-H2_1*H_1*rh2formation_h2mcool[i] + pow(H_1, 3)*rh2formation_h2mheat[i]);



        SM_ELEMENT_D( J, j + 9, j + 9 ) *= inv_mdensity;


        SM_ELEMENT_D( J, j + 9, j + 9 ) *= Tge[i];


    }
    return 0;
}






int calculate_rhs_final_(realtype t, N_Vector y, N_Vector ydot, void *user_data)
{
    final__data *data = (final__data* ) user_data;
    int i, j;

    int nchem = 10;
    int nstrip = data->nstrip;

    /* change N_Vector back to an array */
    double y_arr[ 10 * nstrip ];
    double H2_1;

    double H2_2;

    double H_1;

    double H_2;

    double H_m0;

    double He_1;

    double He_2;

    double He_3;

    double de;

    double ge;


    double *scale     = data->scale;
    double *inv_scale = data->inv_scale;

    for ( i = 0; i < nstrip; i++ ){
        j = i * nchem;
        y_arr[j] = NV_Ith_S( y, j )*scale[j];
        j++;
        y_arr[j] = NV_Ith_S( y, j )*scale[j];
        j++;
        y_arr[j] = NV_Ith_S( y, j )*scale[j];
        j++;
        y_arr[j] = NV_Ith_S( y, j )*scale[j];
        j++;
        y_arr[j] = NV_Ith_S( y, j )*scale[j];
        j++;
        y_arr[j] = NV_Ith_S( y, j )*scale[j];
        j++;
        y_arr[j] = NV_Ith_S( y, j )*scale[j];
        j++;
        y_arr[j] = NV_Ith_S( y, j )*scale[j];
        j++;
        y_arr[j] = NV_Ith_S( y, j )*scale[j];
        j++;
        y_arr[j] = NV_Ith_S( y, j )*scale[j];
        j++;
    }
   /*
    for (i = 0; i < nchem; i++){
        fprintf(stderr , "y[%d] = %0.5g \n", i , NV_Ith_S( y, i ) );
    }
*/
    int flag;
    flag = final__calculate_temperature(data, y_arr , nstrip, nchem );
    if (flag > 0){
        // check if the temperature failed to converged
        return -1;
    }
    final__interpolate_rates(data, nstrip);


    /* Now we set up some temporaries */
    double *k01 = data->rs_k01;
    double *k02 = data->rs_k02;
    double *k03 = data->rs_k03;
    double *k04 = data->rs_k04;
    double *k05 = data->rs_k05;
    double *k06 = data->rs_k06;
    double *k07 = data->rs_k07;
    double *k08 = data->rs_k08;
    double *k09 = data->rs_k09;
    double *k10 = data->rs_k10;
    double *k11 = data->rs_k11;
    double *k12 = data->rs_k12;
    double *k13 = data->rs_k13;
    double *k14 = data->rs_k14;
    double *k15 = data->rs_k15;
    double *k16 = data->rs_k16;
    double *k17 = data->rs_k17;
    double *k18 = data->rs_k18;
    double *k19 = data->rs_k19;
    double *k21 = data->rs_k21;
    double *k22 = data->rs_k22;
    double *brem_brem = data->cs_brem_brem;
    double *ceHeI_ceHeI = data->cs_ceHeI_ceHeI;
    double *ceHeII_ceHeII = data->cs_ceHeII_ceHeII;
    double *ceHI_ceHI = data->cs_ceHI_ceHI;
    double *ciHeI_ciHeI = data->cs_ciHeI_ciHeI;
    double *ciHeII_ciHeII = data->cs_ciHeII_ciHeII;
    double *ciHeIS_ciHeIS = data->cs_ciHeIS_ciHeIS;
    double *ciHI_ciHI = data->cs_ciHI_ciHI;
    double *compton_comp_ = data->cs_compton_comp_;
    double *gammah_gammah = data->cs_gammah_gammah;
    double *gloverabel08_gael = data->cs_gloverabel08_gael;
    double *gloverabel08_gaH2 = data->cs_gloverabel08_gaH2;
    double *gloverabel08_gaHe = data->cs_gloverabel08_gaHe;
    double *gloverabel08_gaHI = data->cs_gloverabel08_gaHI;
    double *gloverabel08_gaHp = data->cs_gloverabel08_gaHp;
    double *gloverabel08_gphdl = data->cs_gloverabel08_gphdl;
    double *gloverabel08_gpldl = data->cs_gloverabel08_gpldl;
    double *gloverabel08_h2lte = data->cs_gloverabel08_h2lte;
    double *h2formation_h2mcool = data->cs_h2formation_h2mcool;
    double *h2formation_h2mheat = data->cs_h2formation_h2mheat;
    double *h2formation_ncrd1 = data->cs_h2formation_ncrd1;
    double *h2formation_ncrd2 = data->cs_h2formation_ncrd2;
    double *h2formation_ncrn = data->cs_h2formation_ncrn;
    double *reHeII1_reHeII1 = data->cs_reHeII1_reHeII1;
    double *reHeII2_reHeII2 = data->cs_reHeII2_reHeII2;
    double *reHeIII_reHeIII = data->cs_reHeIII_reHeIII;
    double *reHII_reHII = data->cs_reHII_reHII;

    double z;
    double T;

    double mh = 1.67e-24;
    double mdensity, inv_mdensity;


    for ( i = 0; i < nstrip; i++ ){

        T            = data->Ts[i];
        z            = data->current_z;
        mdensity     = data->mdensity[i];
        inv_mdensity = data->inv_mdensity[i];

        j = i * nchem;
        H2_1 = y_arr[j];
        j++;
        H2_2 = y_arr[j];
        j++;
        H_1 = y_arr[j];
        j++;
        H_2 = y_arr[j];
        j++;
        H_m0 = y_arr[j];
        j++;
        He_1 = y_arr[j];
        j++;
        He_2 = y_arr[j];
        j++;
        He_3 = y_arr[j];
        j++;
        de = y_arr[j];
        j++;
        ge = y_arr[j];
        j++;


        j = i * nchem;
        //
        // Species: H2_1
        //
        NV_Ith_S( ydot, j ) = k08[i]*H_1*H_m0 + k10[i]*H2_2*H_1 - k11[i]*H2_1*H_2 - k12[i]*H2_1*de - k13[i]*H2_1*H_1 + k19[i]*H2_2*H_m0 + k21[i]*H2_1*H_1*H_1 + k22[i]*H_1*H_1*H_1;
        NV_Ith_S( ydot, j ) *= inv_scale[j];

        j++;
        //fprintf(stderr, "H2_1: %0.5g\n", scale);
        //fprintf(stderr, "ydot = %0.5g \n", NV_Ith_S(ydot, 0));

        //
        // Species: H2_2
        //
        NV_Ith_S( ydot, j ) = k09[i]*H_1*H_2 - k10[i]*H2_2*H_1 + k11[i]*H2_1*H_2 + k17[i]*H_2*H_m0 - k18[i]*H2_2*de - k19[i]*H2_2*H_m0;
        NV_Ith_S( ydot, j ) *= inv_scale[j];

        j++;
        //fprintf(stderr, "H2_2: %0.5g\n", scale);
        //fprintf(stderr, "ydot = %0.5g \n", NV_Ith_S(ydot, 1));

        //
        // Species: H_1
        //
        NV_Ith_S( ydot, j ) = -k01[i]*H_1*de + k02[i]*H_2*de - k07[i]*H_1*de - k08[i]*H_1*H_m0 - k09[i]*H_1*H_2 - k10[i]*H2_2*H_1 + k11[i]*H2_1*H_2 + 2*k12[i]*H2_1*de + 2*k13[i]*H2_1*H_1 + k14[i]*H_m0*de + k15[i]*H_1*H_m0 + 2*k16[i]*H_2*H_m0 + 2*k18[i]*H2_2*de + k19[i]*H2_2*H_m0 - 2*k21[i]*H2_1*H_1*H_1 - 2*k22[i]*H_1*H_1*H_1;
        NV_Ith_S( ydot, j ) *= inv_scale[j];

        j++;
        //fprintf(stderr, "H_1: %0.5g\n", scale);
        //fprintf(stderr, "ydot = %0.5g \n", NV_Ith_S(ydot, 2));

        //
        // Species: H_2
        //
        NV_Ith_S( ydot, j ) = k01[i]*H_1*de - k02[i]*H_2*de - k09[i]*H_1*H_2 + k10[i]*H2_2*H_1 - k11[i]*H2_1*H_2 - k16[i]*H_2*H_m0 - k17[i]*H_2*H_m0;
        NV_Ith_S( ydot, j ) *= inv_scale[j];

        j++;
        //fprintf(stderr, "H_2: %0.5g\n", scale);
        //fprintf(stderr, "ydot = %0.5g \n", NV_Ith_S(ydot, 3));

        //
        // Species: H_m0
        //
        NV_Ith_S( ydot, j ) = k07[i]*H_1*de - k08[i]*H_1*H_m0 - k14[i]*H_m0*de - k15[i]*H_1*H_m0 - k16[i]*H_2*H_m0 - k17[i]*H_2*H_m0 - k19[i]*H2_2*H_m0;
        NV_Ith_S( ydot, j ) *= inv_scale[j];

        j++;
        //fprintf(stderr, "H_m0: %0.5g\n", scale);
        //fprintf(stderr, "ydot = %0.5g \n", NV_Ith_S(ydot, 4));

        //
        // Species: He_1
        //
        NV_Ith_S( ydot, j ) = -k03[i]*He_1*de + k04[i]*He_2*de;
        NV_Ith_S( ydot, j ) *= inv_scale[j];

        j++;
        //fprintf(stderr, "He_1: %0.5g\n", scale);
        //fprintf(stderr, "ydot = %0.5g \n", NV_Ith_S(ydot, 5));

        //
        // Species: He_2
        //
        NV_Ith_S( ydot, j ) = k03[i]*He_1*de - k04[i]*He_2*de - k05[i]*He_2*de + k06[i]*He_3*de;
        NV_Ith_S( ydot, j ) *= inv_scale[j];

        j++;
        //fprintf(stderr, "He_2: %0.5g\n", scale);
        //fprintf(stderr, "ydot = %0.5g \n", NV_Ith_S(ydot, 6));

        //
        // Species: He_3
        //
        NV_Ith_S( ydot, j ) = k05[i]*He_2*de - k06[i]*He_3*de;
        NV_Ith_S( ydot, j ) *= inv_scale[j];

        j++;
        //fprintf(stderr, "He_3: %0.5g\n", scale);
        //fprintf(stderr, "ydot = %0.5g \n", NV_Ith_S(ydot, 7));

        //
        // Species: de
        //
        NV_Ith_S( ydot, j ) = k01[i]*H_1*de - k02[i]*H_2*de + k03[i]*He_1*de - k04[i]*He_2*de + k05[i]*He_2*de - k06[i]*He_3*de - k07[i]*H_1*de + k08[i]*H_1*H_m0 + k14[i]*H_m0*de + k15[i]*H_1*H_m0 + k17[i]*H_2*H_m0 - k18[i]*H2_2*de;
        NV_Ith_S( ydot, j ) *= inv_scale[j];

        j++;
        //fprintf(stderr, "de: %0.5g\n", scale);
        //fprintf(stderr, "ydot = %0.5g \n", NV_Ith_S(ydot, 8));

        //
        // Species: ge
        //
        NV_Ith_S( ydot, j ) = (-H2_1*gloverabel08_h2lte[i]/(gloverabel08_h2lte[i]/(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i]) + 1.0) - H_1*ceHI_ceHI[i]*de - H_1*ciHI_ciHI[i]*de - H_2*de*reHII_reHII[i] - He_1*ciHeI_ciHeI[i]*de - He_2*ceHeII_ceHeII[i]*de - He_2*ceHeI_ceHeI[i]*pow(de, 2) - He_2*ciHeII_ciHeII[i]*de - He_2*ciHeIS_ciHeIS[i]*pow(de, 2) - He_2*de*reHeII1_reHeII1[i] - He_2*de*reHeII2_reHeII2[i] - He_3*de*reHeIII_reHeIII[i] - brem_brem[i]*de*(H_2 + He_2 + 4.0*He_3) - compton_comp_[i]*de*pow(z + 1.0, 4)*(T - 2.73*z - 2.73) + 0.5*1.0/(h2formation_ncrn[i]/(H2_1*h2formation_ncrd2[i] + H_1*h2formation_ncrd1[i]) + 1.0)*(-H2_1*H_1*h2formation_h2mcool[i] + pow(H_1, 3)*h2formation_h2mheat[i]))*fmin(1.00000000000000, (1.0 - exp(-fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8))))/fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8)));
        NV_Ith_S( ydot, j ) *= inv_scale[j];



        NV_Ith_S( ydot, j ) *= inv_mdensity;

        j++;
        //fprintf(stderr, "ge: %0.5g\n", scale);
        //fprintf(stderr, "ydot = %0.5g \n", NV_Ith_S(ydot, 9));


    //fprintf(stderr, "----------------\n");
    }
    return 0;
    }



#ifndef IGNORED

int final__solve_chemistry_dt( dengo_field_data *field_data,
final__data *data, double dt ){

    int i, j;
    int N = 10;
    int dims = field_data->ncells; // total number of strips to be evaluated


    // turned the field data into a long chain of
    // 1-D array
    //
    // N: number of species
    // d: d th number of strip to be evalulated
    // i: index for each species
    //    should be in correct order and handled
    //    by dengo templates
    // i.e.
    // input[d*N + i] = field_data->HI_density[]
    //


    double *input = (double *) malloc(dims * N * sizeof(double));
    double *atol  = (double *) malloc(dims * N * sizeof(double));
    double *rtol  = (double *) malloc(dims * N * sizeof(double));
    double *temp  = (double *) malloc(dims * sizeof(double) );


    for ( int d = 0; d< dims; d++  ){
        j = d*N;
        // this should be the normalized
        // by the input units later
        // atol = input * rtol;
        // which again should be set by dengo
        input[j] = field_data->H2_1_density[d];
        input[j] /= 2.01588;
        atol[j] = input[j] * 1.0e-9;
        j++;

        input[j] = field_data->H2_2_density[d];
        input[j] /= 2.01588;
        atol[j] = input[j] * 1.0e-9;
        j++;

        input[j] = field_data->H_1_density[d];
        input[j] /= 1.00794;
        atol[j] = input[j] * 1.0e-9;
        j++;

        input[j] = field_data->H_2_density[d];
        input[j] /= 1.00794;
        atol[j] = input[j] * 1.0e-9;
        j++;

        input[j] = field_data->H_m0_density[d];
        input[j] /= 1.00794;
        atol[j] = input[j] * 1.0e-9;
        j++;

        input[j] = field_data->He_1_density[d];
        input[j] /= 4.002602;
        atol[j] = input[j] * 1.0e-9;
        j++;

        input[j] = field_data->He_2_density[d];
        input[j] /= 4.002602;
        atol[j] = input[j] * 1.0e-9;
        j++;

        input[j] = field_data->He_3_density[d];
        input[j] /= 4.002602;
        atol[j] = input[j] * 1.0e-9;
        j++;

        input[j] = field_data->de_density[d];
        input[j] /= 1.0;
        atol[j] = input[j] * 1.0e-9;
        j++;

        input[j] = field_data->ge_density[d];
        input[j] /= 1.0;
        atol[j] = input[j] * 1.0e-9;
        j++;

    }

    double ttot;
    double z;

    ttot = dengo_evolve_final_( dt, dt, z, input, rtol, atol, dims, data, temp );

    for ( int d = 0; d< dims; d++  ){
        j = d*N;
        // this should be the normalized
        // by the input units later
        // atol = input * rtol;
        // which again should be set by dengo
        field_data->H2_1_density[d] = input[j] * 2.01588;
        j++;

        field_data->H2_2_density[d] = input[j] * 2.01588;
        j++;

        field_data->H_1_density[d] = input[j] * 1.00794;
        j++;

        field_data->H_2_density[d] = input[j] * 1.00794;
        j++;

        field_data->H_m0_density[d] = input[j] * 1.00794;
        j++;

        field_data->He_1_density[d] = input[j] * 4.002602;
        j++;

        field_data->He_2_density[d] = input[j] * 4.002602;
        j++;

        field_data->He_3_density[d] = input[j] * 4.002602;
        j++;

        field_data->de_density[d] = input[j] * 1.0;
        j++;

        field_data->ge_density[d] = input[j] * 1.0;
        j++;

    }


}





int read_init_data_to_dengo( dengo_field_data *field_data ){

    // this reads the initial abundances of the data from
    // a hdf5 file, and initialize a field_data object

    char const *filename;
    filename = "newIC.h5";

    hid_t file_id = H5Fopen(filename, H5F_ACC_RDONLY, H5P_DEFAULT);

    if (file_id < 0){
        fprintf(stderr, "failed to open %s so dying. \n", filename);
        return (1);
        }

    hsize_t dims;


    /* Check gas energy to get the number of cells */
    fprintf(stderr, "Getting dimensionality from ge:\n");
    herr_t status = H5LTget_dataset_info(file_id, "/ge", &dims, NULL, NULL);
    if(status == -1) {
        fprintf(stderr, "Error opening initial conditions file.\n");
        return 1;
    }
    fprintf(stderr, "  ncells = % 3i\n", (int) dims);

    field_data->ncells = (int) dims;

    int N = 10;


    double *atol, *rtol;
    atol = (double *) malloc(N * dims * sizeof(double));
    rtol = (double *) malloc(N * dims * sizeof(double));

    double *tics = (double *) malloc(dims * sizeof(double));
    double *ics = (double *) malloc(dims * N * sizeof(double));
    double *input = (double *) malloc(dims * N * sizeof(double));

    unsigned int i = 0, j;
    double *H2_1 = (double *) malloc(dims * sizeof(double));
    field_data->H2_1_density = H2_1;

    double *H2_2 = (double *) malloc(dims * sizeof(double));
    field_data->H2_2_density = H2_2;

    double *H_1 = (double *) malloc(dims * sizeof(double));
    field_data->H_1_density = H_1;

    double *H_2 = (double *) malloc(dims * sizeof(double));
    field_data->H_2_density = H_2;

    double *H_m0 = (double *) malloc(dims * sizeof(double));
    field_data->H_m0_density = H_m0;

    double *He_1 = (double *) malloc(dims * sizeof(double));
    field_data->He_1_density = He_1;

    double *He_2 = (double *) malloc(dims * sizeof(double));
    field_data->He_2_density = He_2;

    double *He_3 = (double *) malloc(dims * sizeof(double));
    field_data->He_3_density = He_3;

    double *de = (double *) malloc(dims * sizeof(double));
    field_data->de_density = de;

    double *ge = (double *) malloc(dims * sizeof(double));
    field_data->ge_density = ge;

    fprintf(stderr, "Reading I.C. for /H2_1\n");
    H5LTread_dataset_double(file_id, "/H2_1", tics);
    for ( j = 0; j < dims; j++ ){
        field_data->H2_1_density[j] = tics[j];
        if (j == 0){
            fprintf(stderr, "H2_1[0] = %0.3g \n", tics[j] );
        }
    }
    i++;

    fprintf(stderr, "Reading I.C. for /H2_2\n");
    H5LTread_dataset_double(file_id, "/H2_2", tics);
    for ( j = 0; j < dims; j++ ){
        field_data->H2_2_density[j] = tics[j];
        if (j == 0){
            fprintf(stderr, "H2_2[0] = %0.3g \n", tics[j] );
        }
    }
    i++;

    fprintf(stderr, "Reading I.C. for /H_1\n");
    H5LTread_dataset_double(file_id, "/H_1", tics);
    for ( j = 0; j < dims; j++ ){
        field_data->H_1_density[j] = tics[j];
        if (j == 0){
            fprintf(stderr, "H_1[0] = %0.3g \n", tics[j] );
        }
    }
    i++;

    fprintf(stderr, "Reading I.C. for /H_2\n");
    H5LTread_dataset_double(file_id, "/H_2", tics);
    for ( j = 0; j < dims; j++ ){
        field_data->H_2_density[j] = tics[j];
        if (j == 0){
            fprintf(stderr, "H_2[0] = %0.3g \n", tics[j] );
        }
    }
    i++;

    fprintf(stderr, "Reading I.C. for /H_m0\n");
    H5LTread_dataset_double(file_id, "/H_m0", tics);
    for ( j = 0; j < dims; j++ ){
        field_data->H_m0_density[j] = tics[j];
        if (j == 0){
            fprintf(stderr, "H_m0[0] = %0.3g \n", tics[j] );
        }
    }
    i++;

    fprintf(stderr, "Reading I.C. for /He_1\n");
    H5LTread_dataset_double(file_id, "/He_1", tics);
    for ( j = 0; j < dims; j++ ){
        field_data->He_1_density[j] = tics[j];
        if (j == 0){
            fprintf(stderr, "He_1[0] = %0.3g \n", tics[j] );
        }
    }
    i++;

    fprintf(stderr, "Reading I.C. for /He_2\n");
    H5LTread_dataset_double(file_id, "/He_2", tics);
    for ( j = 0; j < dims; j++ ){
        field_data->He_2_density[j] = tics[j];
        if (j == 0){
            fprintf(stderr, "He_2[0] = %0.3g \n", tics[j] );
        }
    }
    i++;

    fprintf(stderr, "Reading I.C. for /He_3\n");
    H5LTread_dataset_double(file_id, "/He_3", tics);
    for ( j = 0; j < dims; j++ ){
        field_data->He_3_density[j] = tics[j];
        if (j == 0){
            fprintf(stderr, "He_3[0] = %0.3g \n", tics[j] );
        }
    }
    i++;

    fprintf(stderr, "Reading I.C. for /de\n");
    H5LTread_dataset_double(file_id, "/de", tics);
    for ( j = 0; j < dims; j++ ){
        field_data->de_density[j] = tics[j];
        if (j == 0){
            fprintf(stderr, "de[0] = %0.3g \n", tics[j] );
        }
    }
    i++;

    fprintf(stderr, "Reading I.C. for /ge\n");
    H5LTread_dataset_double(file_id, "/ge", tics);
    for ( j = 0; j < dims; j++ ){
        field_data->ge_density[j] = tics[j];
        if (j == 0){
            fprintf(stderr, "ge[0] = %0.3g \n", tics[j] );
        }
    }
    i++;


    H5Fclose(file_id);
    free(input);
    free(atol);
    free(rtol);
    free(ics);

    return 1;

}
#endif




int calculate_JacTimesVec_final_
            (N_Vector v, N_Vector Jv, realtype t,
             N_Vector y, N_Vector fy,
             void *user_data, N_Vector tmp)
{
    /* We iterate over all of the rates */
    /* Calcuate temperature first */
    int nstrip = 1;
    int nchem = 10;
    final__data *data = (final__data*)user_data;


    int i, j;
    j = 0;

     /* change N_Vector back to an array */
    double y_arr[ 10 ];
    y_arr[0] = Ith(y , 1);
    y_arr[1] = Ith(y , 2);
    y_arr[2] = Ith(y , 3);
    y_arr[3] = Ith(y , 4);
    y_arr[4] = Ith(y , 5);
    y_arr[5] = Ith(y , 6);
    y_arr[6] = Ith(y , 7);
    y_arr[7] = Ith(y , 8);
    y_arr[8] = Ith(y , 9);
    y_arr[9] = Ith(y , 10);
    // Abundances are scaled in the calculate temperature module
    int flag;
    flag = final__calculate_temperature(data, y_arr, nstrip, nchem);
    if (flag > 0){
        return 1;
    }

    final__interpolate_rates(data, nstrip);

    /* Now We set up some temporaries */
    double *Tge = data->dTs_ge;

    /* Define the reaction rates */
    double *k01 = data->rs_k01;
    double *rk01 = data->drs_k01;
    double *k02 = data->rs_k02;
    double *rk02 = data->drs_k02;
    double *k03 = data->rs_k03;
    double *rk03 = data->drs_k03;
    double *k04 = data->rs_k04;
    double *rk04 = data->drs_k04;
    double *k05 = data->rs_k05;
    double *rk05 = data->drs_k05;
    double *k06 = data->rs_k06;
    double *rk06 = data->drs_k06;
    double *k07 = data->rs_k07;
    double *rk07 = data->drs_k07;
    double *k08 = data->rs_k08;
    double *rk08 = data->drs_k08;
    double *k09 = data->rs_k09;
    double *rk09 = data->drs_k09;
    double *k10 = data->rs_k10;
    double *rk10 = data->drs_k10;
    double *k11 = data->rs_k11;
    double *rk11 = data->drs_k11;
    double *k12 = data->rs_k12;
    double *rk12 = data->drs_k12;
    double *k13 = data->rs_k13;
    double *rk13 = data->drs_k13;
    double *k14 = data->rs_k14;
    double *rk14 = data->drs_k14;
    double *k15 = data->rs_k15;
    double *rk15 = data->drs_k15;
    double *k16 = data->rs_k16;
    double *rk16 = data->drs_k16;
    double *k17 = data->rs_k17;
    double *rk17 = data->drs_k17;
    double *k18 = data->rs_k18;
    double *rk18 = data->drs_k18;
    double *k19 = data->rs_k19;
    double *rk19 = data->drs_k19;
    double *k21 = data->rs_k21;
    double *rk21 = data->drs_k21;
    double *k22 = data->rs_k22;
    double *rk22 = data->drs_k22;
    double *brem_brem = data->cs_brem_brem;
    double *rbrem_brem = data->dcs_brem_brem;
    double *ceHeI_ceHeI = data->cs_ceHeI_ceHeI;
    double *rceHeI_ceHeI = data->dcs_ceHeI_ceHeI;
    double *ceHeII_ceHeII = data->cs_ceHeII_ceHeII;
    double *rceHeII_ceHeII = data->dcs_ceHeII_ceHeII;
    double *ceHI_ceHI = data->cs_ceHI_ceHI;
    double *rceHI_ceHI = data->dcs_ceHI_ceHI;
    double *ciHeI_ciHeI = data->cs_ciHeI_ciHeI;
    double *rciHeI_ciHeI = data->dcs_ciHeI_ciHeI;
    double *ciHeII_ciHeII = data->cs_ciHeII_ciHeII;
    double *rciHeII_ciHeII = data->dcs_ciHeII_ciHeII;
    double *ciHeIS_ciHeIS = data->cs_ciHeIS_ciHeIS;
    double *rciHeIS_ciHeIS = data->dcs_ciHeIS_ciHeIS;
    double *ciHI_ciHI = data->cs_ciHI_ciHI;
    double *rciHI_ciHI = data->dcs_ciHI_ciHI;
    double *compton_comp_ = data->cs_compton_comp_;
    double *rcompton_comp_ = data->dcs_compton_comp_;
    double *gammah_gammah = data->cs_gammah_gammah;
    double *rgammah_gammah = data->dcs_gammah_gammah;
    double *gloverabel08_gael = data->cs_gloverabel08_gael;
    double *rgloverabel08_gael = data->dcs_gloverabel08_gael;
    double *gloverabel08_gaH2 = data->cs_gloverabel08_gaH2;
    double *rgloverabel08_gaH2 = data->dcs_gloverabel08_gaH2;
    double *gloverabel08_gaHe = data->cs_gloverabel08_gaHe;
    double *rgloverabel08_gaHe = data->dcs_gloverabel08_gaHe;
    double *gloverabel08_gaHI = data->cs_gloverabel08_gaHI;
    double *rgloverabel08_gaHI = data->dcs_gloverabel08_gaHI;
    double *gloverabel08_gaHp = data->cs_gloverabel08_gaHp;
    double *rgloverabel08_gaHp = data->dcs_gloverabel08_gaHp;
    double *gloverabel08_gphdl = data->cs_gloverabel08_gphdl;
    double *rgloverabel08_gphdl = data->dcs_gloverabel08_gphdl;
    double *gloverabel08_gpldl = data->cs_gloverabel08_gpldl;
    double *rgloverabel08_gpldl = data->dcs_gloverabel08_gpldl;
    double *gloverabel08_h2lte = data->cs_gloverabel08_h2lte;
    double *rgloverabel08_h2lte = data->dcs_gloverabel08_h2lte;
    double *h2formation_h2mcool = data->cs_h2formation_h2mcool;
    double *rh2formation_h2mcool = data->dcs_h2formation_h2mcool;
    double *h2formation_h2mheat = data->cs_h2formation_h2mheat;
    double *rh2formation_h2mheat = data->dcs_h2formation_h2mheat;
    double *h2formation_ncrd1 = data->cs_h2formation_ncrd1;
    double *rh2formation_ncrd1 = data->dcs_h2formation_ncrd1;
    double *h2formation_ncrd2 = data->cs_h2formation_ncrd2;
    double *rh2formation_ncrd2 = data->dcs_h2formation_ncrd2;
    double *h2formation_ncrn = data->cs_h2formation_ncrn;
    double *rh2formation_ncrn = data->dcs_h2formation_ncrn;
    double *reHeII1_reHeII1 = data->cs_reHeII1_reHeII1;
    double *rreHeII1_reHeII1 = data->dcs_reHeII1_reHeII1;
    double *reHeII2_reHeII2 = data->cs_reHeII2_reHeII2;
    double *rreHeII2_reHeII2 = data->dcs_reHeII2_reHeII2;
    double *reHeIII_reHeIII = data->cs_reHeIII_reHeIII;
    double *rreHeIII_reHeIII = data->dcs_reHeIII_reHeIII;
    double *reHII_reHII = data->cs_reHII_reHII;
    double *rreHII_reHII = data->dcs_reHII_reHII;


    double scale;
    /* Define the species */
    double H2_1, v0;
    double H2_2, v1;
    double H_1, v2;
    double H_2, v3;
    double H_m0, v4;
    double He_1, v5;
    double He_2, v6;
    double He_3, v7;
    double de, v8;
    double ge, v9;
    scale = data->scale[0];
    v0 = Ith( v, 1 );
    v0 *= scale;
    scale = data->scale[1];
    v1 = Ith( v, 2 );
    v1 *= scale;
    scale = data->scale[2];
    v2 = Ith( v, 3 );
    v2 *= scale;
    scale = data->scale[3];
    v3 = Ith( v, 4 );
    v3 *= scale;
    scale = data->scale[4];
    v4 = Ith( v, 5 );
    v4 *= scale;
    scale = data->scale[5];
    v5 = Ith( v, 6 );
    v5 *= scale;
    scale = data->scale[6];
    v6 = Ith( v, 7 );
    v6 *= scale;
    scale = data->scale[7];
    v7 = Ith( v, 8 );
    v7 *= scale;
    scale = data->scale[8];
    v8 = Ith( v, 9 );
    v8 *= scale;
    scale = data->scale[9];
    v9 = Ith( v, 10 );
    v9 *= scale;

    double z;
    double T;

    double mh = 1.67e-24;
    double mdensity;

    int jj;
    jj = 0;

    j = i*nchem;
    mdensity = 0.0;
    z = data->current_z;
        // Rescale the Species abundance
    scale = data->scale[j];
    H2_1 = Ith( y, 1  )*scale;

    mdensity += H2_1;

    j++;

        // Rescale the Species abundance
    scale = data->scale[j];
    H2_2 = Ith( y, 2  )*scale;

    mdensity += H2_2;

    j++;

        // Rescale the Species abundance
    scale = data->scale[j];
    H_1 = Ith( y, 3  )*scale;

    mdensity += H_1;

    j++;

        // Rescale the Species abundance
    scale = data->scale[j];
    H_2 = Ith( y, 4  )*scale;

    mdensity += H_2;

    j++;

        // Rescale the Species abundance
    scale = data->scale[j];
    H_m0 = Ith( y, 5  )*scale;

    mdensity += H_m0;

    j++;

        // Rescale the Species abundance
    scale = data->scale[j];
    He_1 = Ith( y, 6  )*scale;

    mdensity += He_1;

    j++;

        // Rescale the Species abundance
    scale = data->scale[j];
    He_2 = Ith( y, 7  )*scale;

    mdensity += He_2;

    j++;

        // Rescale the Species abundance
    scale = data->scale[j];
    He_3 = Ith( y, 8  )*scale;

    mdensity += He_3;

    j++;

        // Rescale the Species abundance
    scale = data->scale[j];
    de = Ith( y, 9  )*scale;

    j++;

        // Rescale the Species abundance
    scale = data->scale[j];
    ge = Ith( y, 10  )*scale;

    j++;



    mdensity *= mh;

    j = 0;
    //
    // Species: H2_1
    //
    Ith(Jv, 1 ) = -k11[i]*H2_1*v3 - k12[i]*H2_1*v8 + v0*(-k11[i]*H_2 - k12[i]*de - k13[i]*H_1 + k21[i]*H_1*H_1) + v1*(k10[i]*H_1 + k19[i]*H_m0) + v2*(k08[i]*H_m0 + k10[i]*H2_2 - k13[i]*H2_1) + v4*(k08[i]*H_1 + k19[i]*H2_2);

    scale = data->scale[0];
    Ith(Jv, 1) /= scale;


    //
    // Species: H2_2
    //
    Ith(Jv, 2 ) = k11[i]*H_2*v0 - k18[i]*H2_2*v8 + v1*(-k10[i]*H_1 - k18[i]*de - k19[i]*H_m0) + v2*(k09[i]*H_2 - k10[i]*H2_2) + v3*(k09[i]*H_1 + k11[i]*H2_1 + k17[i]*H_m0) + v4*(k17[i]*H_2 - k19[i]*H2_2);

    scale = data->scale[1];
    Ith(Jv, 2) /= scale;


    //
    // Species: H_1
    //
    Ith(Jv, 3 ) = v0*(k11[i]*H_2 + 2*k12[i]*de + 2*k13[i]*H_1 - 2*k21[i]*H_1*H_1) + v1*(-k10[i]*H_1 + 2*k18[i]*de + k19[i]*H_m0) + v2*(-k01[i]*de - k07[i]*de - k08[i]*H_m0 - k09[i]*H_2 - k10[i]*H2_2 + 2*k13[i]*H2_1 + k15[i]*H_m0) + v3*(k02[i]*de - k09[i]*H_1 + k11[i]*H2_1 + 2*k16[i]*H_m0) + v4*(-k08[i]*H_1 + k14[i]*de + k15[i]*H_1 + 2*k16[i]*H_2 + k19[i]*H2_2) + v8*(-k01[i]*H_1 + k02[i]*H_2 - k07[i]*H_1 + 2*k12[i]*H2_1 + k14[i]*H_m0 + 2*k18[i]*H2_2);

    scale = data->scale[2];
    Ith(Jv, 3) /= scale;


    //
    // Species: H_2
    //
    Ith(Jv, 4 ) = k10[i]*H_1*v1 - k11[i]*H_2*v0 + v2*(k01[i]*de - k09[i]*H_2 + k10[i]*H2_2) + v3*(-k02[i]*de - k09[i]*H_1 - k11[i]*H2_1 - k16[i]*H_m0 - k17[i]*H_m0) + v4*(-k16[i]*H_2 - k17[i]*H_2) + v8*(k01[i]*H_1 - k02[i]*H_2);

    scale = data->scale[3];
    Ith(Jv, 4) /= scale;


    //
    // Species: H_m0
    //
    Ith(Jv, 5 ) = -k19[i]*H_m0*v1 + v2*(k07[i]*de - k08[i]*H_m0 - k15[i]*H_m0) + v3*(-k16[i]*H_m0 - k17[i]*H_m0) + v4*(-k08[i]*H_1 - k14[i]*de - k15[i]*H_1 - k16[i]*H_2 - k17[i]*H_2 - k19[i]*H2_2) + v8*(k07[i]*H_1 - k14[i]*H_m0);

    scale = data->scale[4];
    Ith(Jv, 5) /= scale;


    //
    // Species: He_1
    //
    Ith(Jv, 6 ) = -k03[i]*de*v5 + k04[i]*de*v6 + v8*(-k03[i]*He_1 + k04[i]*He_2);

    scale = data->scale[5];
    Ith(Jv, 6) /= scale;


    //
    // Species: He_2
    //
    Ith(Jv, 7 ) = k03[i]*de*v5 + k06[i]*de*v7 + v6*(-k04[i]*de - k05[i]*de) + v8*(k03[i]*He_1 - k04[i]*He_2 - k05[i]*He_2 + k06[i]*He_3);

    scale = data->scale[6];
    Ith(Jv, 7) /= scale;


    //
    // Species: He_3
    //
    Ith(Jv, 8 ) = k05[i]*de*v6 - k06[i]*de*v7 + v8*(k05[i]*He_2 - k06[i]*He_3);

    scale = data->scale[7];
    Ith(Jv, 8) /= scale;


    //
    // Species: de
    //
    Ith(Jv, 9 ) = k03[i]*de*v5 - k06[i]*de*v7 - k18[i]*de*v1 + v2*(k01[i]*de - k07[i]*de + k08[i]*H_m0 + k15[i]*H_m0) + v3*(-k02[i]*de + k17[i]*H_m0) + v4*(k08[i]*H_1 + k14[i]*de + k15[i]*H_1 + k17[i]*H_2) + v6*(-k04[i]*de + k05[i]*de) + v8*(k01[i]*H_1 - k02[i]*H_2 + k03[i]*He_1 - k04[i]*He_2 + k05[i]*He_2 - k06[i]*He_3 - k07[i]*H_1 + k14[i]*H_m0 - k18[i]*H2_2);

    scale = data->scale[8];
    Ith(Jv, 9) /= scale;


    //
    // Species: ge
    //
    Ith(Jv, 10 ) = v0*(-H2_1*gloverabel08_gaH2[i]*pow(gloverabel08_h2lte[i], 2)/(pow(gloverabel08_h2lte[i]/(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i]) + 1.0, 2)*pow(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i], 2)) - 0.5*H_1*h2formation_h2mcool[i]*1.0/(h2formation_ncrn[i]/(H2_1*h2formation_ncrd2[i] + H_1*h2formation_ncrd1[i]) + 1.0) - gloverabel08_h2lte[i]/(gloverabel08_h2lte[i]/(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i]) + 1.0) + 0.5*h2formation_ncrd2[i]*h2formation_ncrn[i]*pow(h2formation_ncrn[i]/(H2_1*h2formation_ncrd2[i] + H_1*h2formation_ncrd1[i]) + 1.0, -2.0)*(-H2_1*H_1*h2formation_h2mcool[i] + pow(H_1, 3)*h2formation_h2mheat[i])/pow(H2_1*h2formation_ncrd2[i] + H_1*h2formation_ncrd1[i], 2))*fmin(1.00000000000000, (1.0 - exp(-fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8))))/fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8)))/mdensity + v2*(-H2_1*gloverabel08_gaHI[i]*pow(gloverabel08_h2lte[i], 2)/(pow(gloverabel08_h2lte[i]/(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i]) + 1.0, 2)*pow(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i], 2)) - ceHI_ceHI[i]*de - ciHI_ciHI[i]*de + 0.5*h2formation_ncrd1[i]*h2formation_ncrn[i]*pow(h2formation_ncrn[i]/(H2_1*h2formation_ncrd2[i] + H_1*h2formation_ncrd1[i]) + 1.0, -2.0)*(-H2_1*H_1*h2formation_h2mcool[i] + pow(H_1, 3)*h2formation_h2mheat[i])/pow(H2_1*h2formation_ncrd2[i] + H_1*h2formation_ncrd1[i], 2) + 0.5*(-H2_1*h2formation_h2mcool[i] + 3*pow(H_1, 2)*h2formation_h2mheat[i])*1.0/(h2formation_ncrn[i]/(H2_1*h2formation_ncrd2[i] + H_1*h2formation_ncrd1[i]) + 1.0))*fmin(1.00000000000000, (1.0 - exp(-fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8))))/fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8)))/mdensity + v3*(-H2_1*gloverabel08_gaHp[i]*pow(gloverabel08_h2lte[i], 2)/(pow(gloverabel08_h2lte[i]/(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i]) + 1.0, 2)*pow(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i], 2)) - brem_brem[i]*de - de*reHII_reHII[i])*fmin(1.00000000000000, (1.0 - exp(-fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8))))/fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8)))/mdensity + v5*(-H2_1*gloverabel08_gaHe[i]*pow(gloverabel08_h2lte[i], 2)/(pow(gloverabel08_h2lte[i]/(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i]) + 1.0, 2)*pow(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i], 2)) - ciHeI_ciHeI[i]*de)*fmin(1.00000000000000, (1.0 - exp(-fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8))))/fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8)))/mdensity + v6*(-brem_brem[i]*de - ceHeII_ceHeII[i]*de - ceHeI_ceHeI[i]*pow(de, 2) - ciHeII_ciHeII[i]*de - ciHeIS_ciHeIS[i]*pow(de, 2) - de*reHeII1_reHeII1[i] - de*reHeII2_reHeII2[i])*fmin(1.00000000000000, (1.0 - exp(-fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8))))/fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8)))/mdensity + v7*(-4.0*brem_brem[i]*de - de*reHeIII_reHeIII[i])*fmin(1.00000000000000, (1.0 - exp(-fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8))))/fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8)))/mdensity + v8*(-H2_1*gloverabel08_gael[i]*pow(gloverabel08_h2lte[i], 2)/(pow(gloverabel08_h2lte[i]/(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i]) + 1.0, 2)*pow(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i], 2)) - H_1*ceHI_ceHI[i] - H_1*ciHI_ciHI[i] - H_2*reHII_reHII[i] - He_1*ciHeI_ciHeI[i] - He_2*ceHeII_ceHeII[i] - 2*He_2*ceHeI_ceHeI[i]*de - He_2*ciHeII_ciHeII[i] - 2*He_2*ciHeIS_ciHeIS[i]*de - He_2*reHeII1_reHeII1[i] - He_2*reHeII2_reHeII2[i] - He_3*reHeIII_reHeIII[i] - brem_brem[i]*(H_2 + He_2 + 4.0*He_3) - compton_comp_[i]*pow(z + 1.0, 4)*(T - 2.73*z - 2.73))*fmin(1.00000000000000, (1.0 - exp(-fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8))))/fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8)))/mdensity;

    scale = data->scale[9];
    Ith(Jv, 10) /= scale;


    Ith(Jv, 10) /= mdensity;

    return 0;
}





#ifdef CVKLU
int calculate_sparse_jacobian_final_( realtype t,
                                        N_Vector y, N_Vector fy,
                                        SUNMatrix J, void *user_data,
                                        N_Vector tmp1, N_Vector tmp2,
                                        N_Vector tmp3)
{
    /* We iterate over all of the rates */
    /* Calcuate temperature first */


    final__data *data = (final__data*)user_data;

    int nchem = 10;
    int nstrip = data->nstrip;
    int i, j;

    /* change N_Vector back to an array */
    double y_arr[ 10 * nstrip ];
    double *scale     = data->scale;
    double *inv_scale = data->inv_scale;

    /*
    for ( i = 0; i < nstrip; i++ ){
        j = i * nchem;
        y_arr[j] = NV_Ith_S( y, j )*scale[j];
        j++;
        y_arr[j] = NV_Ith_S( y, j )*scale[j];
        j++;
        y_arr[j] = NV_Ith_S( y, j )*scale[j];
        j++;
        y_arr[j] = NV_Ith_S( y, j )*scale[j];
        j++;
        y_arr[j] = NV_Ith_S( y, j )*scale[j];
        j++;
        y_arr[j] = NV_Ith_S( y, j )*scale[j];
        j++;
        y_arr[j] = NV_Ith_S( y, j )*scale[j];
        j++;
        y_arr[j] = NV_Ith_S( y, j )*scale[j];
        j++;
        y_arr[j] = NV_Ith_S( y, j )*scale[j];
        j++;
        y_arr[j] = NV_Ith_S( y, j )*scale[j];
        j++;
    }

    int flag;
    flag = final__calculate_temperature(data, y_arr , nstrip, nchem );
    if (flag > 0){
        // check if the temperature failed to converged
        return -1;
    }
    final__interpolate_rates(data, nstrip);
    */

    // final__calculate_temperature(data, y_arr, nstrip, nchem);
    // final__interpolate_rates(data, nstrip);

    /* Now We set up some temporaries */

    // CSR is what we choose
    sunindextype *rowptrs = SUNSparseMatrix_IndexPointers(J);
    sunindextype *colvals = SUNSparseMatrix_IndexValues(J);
    realtype *matrix_data = SUNSparseMatrix_Data(J);

    SUNMatZero(J);

    double *Tge = data->dTs_ge;
    double *k01 = data->rs_k01;
    double *rk01= data->drs_k01;
    double *k02 = data->rs_k02;
    double *rk02= data->drs_k02;
    double *k03 = data->rs_k03;
    double *rk03= data->drs_k03;
    double *k04 = data->rs_k04;
    double *rk04= data->drs_k04;
    double *k05 = data->rs_k05;
    double *rk05= data->drs_k05;
    double *k06 = data->rs_k06;
    double *rk06= data->drs_k06;
    double *k07 = data->rs_k07;
    double *rk07= data->drs_k07;
    double *k08 = data->rs_k08;
    double *rk08= data->drs_k08;
    double *k09 = data->rs_k09;
    double *rk09= data->drs_k09;
    double *k10 = data->rs_k10;
    double *rk10= data->drs_k10;
    double *k11 = data->rs_k11;
    double *rk11= data->drs_k11;
    double *k12 = data->rs_k12;
    double *rk12= data->drs_k12;
    double *k13 = data->rs_k13;
    double *rk13= data->drs_k13;
    double *k14 = data->rs_k14;
    double *rk14= data->drs_k14;
    double *k15 = data->rs_k15;
    double *rk15= data->drs_k15;
    double *k16 = data->rs_k16;
    double *rk16= data->drs_k16;
    double *k17 = data->rs_k17;
    double *rk17= data->drs_k17;
    double *k18 = data->rs_k18;
    double *rk18= data->drs_k18;
    double *k19 = data->rs_k19;
    double *rk19= data->drs_k19;
    double *k21 = data->rs_k21;
    double *rk21= data->drs_k21;
    double *k22 = data->rs_k22;
    double *rk22= data->drs_k22;
    double *brem_brem = data->cs_brem_brem;
    double *rbrem_brem = data->dcs_brem_brem;
    double *ceHeI_ceHeI = data->cs_ceHeI_ceHeI;
    double *rceHeI_ceHeI = data->dcs_ceHeI_ceHeI;
    double *ceHeII_ceHeII = data->cs_ceHeII_ceHeII;
    double *rceHeII_ceHeII = data->dcs_ceHeII_ceHeII;
    double *ceHI_ceHI = data->cs_ceHI_ceHI;
    double *rceHI_ceHI = data->dcs_ceHI_ceHI;
    double *ciHeI_ciHeI = data->cs_ciHeI_ciHeI;
    double *rciHeI_ciHeI = data->dcs_ciHeI_ciHeI;
    double *ciHeII_ciHeII = data->cs_ciHeII_ciHeII;
    double *rciHeII_ciHeII = data->dcs_ciHeII_ciHeII;
    double *ciHeIS_ciHeIS = data->cs_ciHeIS_ciHeIS;
    double *rciHeIS_ciHeIS = data->dcs_ciHeIS_ciHeIS;
    double *ciHI_ciHI = data->cs_ciHI_ciHI;
    double *rciHI_ciHI = data->dcs_ciHI_ciHI;
    double *compton_comp_ = data->cs_compton_comp_;
    double *rcompton_comp_ = data->dcs_compton_comp_;
    double *gammah_gammah = data->cs_gammah_gammah;
    double *rgammah_gammah = data->dcs_gammah_gammah;
    double *gloverabel08_gael = data->cs_gloverabel08_gael;
    double *rgloverabel08_gael = data->dcs_gloverabel08_gael;
    double *gloverabel08_gaH2 = data->cs_gloverabel08_gaH2;
    double *rgloverabel08_gaH2 = data->dcs_gloverabel08_gaH2;
    double *gloverabel08_gaHe = data->cs_gloverabel08_gaHe;
    double *rgloverabel08_gaHe = data->dcs_gloverabel08_gaHe;
    double *gloverabel08_gaHI = data->cs_gloverabel08_gaHI;
    double *rgloverabel08_gaHI = data->dcs_gloverabel08_gaHI;
    double *gloverabel08_gaHp = data->cs_gloverabel08_gaHp;
    double *rgloverabel08_gaHp = data->dcs_gloverabel08_gaHp;
    double *gloverabel08_gphdl = data->cs_gloverabel08_gphdl;
    double *rgloverabel08_gphdl = data->dcs_gloverabel08_gphdl;
    double *gloverabel08_gpldl = data->cs_gloverabel08_gpldl;
    double *rgloverabel08_gpldl = data->dcs_gloverabel08_gpldl;
    double *gloverabel08_h2lte = data->cs_gloverabel08_h2lte;
    double *rgloverabel08_h2lte = data->dcs_gloverabel08_h2lte;
    double *h2formation_h2mcool = data->cs_h2formation_h2mcool;
    double *rh2formation_h2mcool = data->dcs_h2formation_h2mcool;
    double *h2formation_h2mheat = data->cs_h2formation_h2mheat;
    double *rh2formation_h2mheat = data->dcs_h2formation_h2mheat;
    double *h2formation_ncrd1 = data->cs_h2formation_ncrd1;
    double *rh2formation_ncrd1 = data->dcs_h2formation_ncrd1;
    double *h2formation_ncrd2 = data->cs_h2formation_ncrd2;
    double *rh2formation_ncrd2 = data->dcs_h2formation_ncrd2;
    double *h2formation_ncrn = data->cs_h2formation_ncrn;
    double *rh2formation_ncrn = data->dcs_h2formation_ncrn;
    double *reHeII1_reHeII1 = data->cs_reHeII1_reHeII1;
    double *rreHeII1_reHeII1 = data->dcs_reHeII1_reHeII1;
    double *reHeII2_reHeII2 = data->cs_reHeII2_reHeII2;
    double *rreHeII2_reHeII2 = data->dcs_reHeII2_reHeII2;
    double *reHeIII_reHeIII = data->cs_reHeIII_reHeIII;
    double *rreHeIII_reHeIII = data->dcs_reHeIII_reHeIII;
    double *reHII_reHII = data->cs_reHII_reHII;
    double *rreHII_reHII = data->dcs_reHII_reHII;
    double H2_1;
    double H2_2;
    double H_1;
    double H_2;
    double H_m0;
    double He_1;
    double He_2;
    double He_3;
    double de;
    double ge;
    double z;
    double T;

    double mh = 1.67e-24;
    double mdensity, inv_mdensity;

    double scale2, inv_scale1;

    j = 0;
    mdensity = 0.0;
    z = data->current_z;

    int k = 0;
    for ( i = 0; i < nstrip; i++ ){
        j = i * nchem;
        H2_1 = NV_Ith_S( y, j )*scale[j];
        j++;

        H2_2 = NV_Ith_S( y, j )*scale[j];
        j++;

        H_1 = NV_Ith_S( y, j )*scale[j];
        j++;

        H_2 = NV_Ith_S( y, j )*scale[j];
        j++;

        H_m0 = NV_Ith_S( y, j )*scale[j];
        j++;

        He_1 = NV_Ith_S( y, j )*scale[j];
        j++;

        He_2 = NV_Ith_S( y, j )*scale[j];
        j++;

        He_3 = NV_Ith_S( y, j )*scale[j];
        j++;

        de = NV_Ith_S( y, j )*scale[j];
        j++;

        ge = NV_Ith_S( y, j )*scale[j];
        j++;


        mdensity = data->mdensity[i];
        inv_mdensity = 1.0 / mdensity;

        j = i * 64;

        // H2_1 by H2_1
        colvals[j + 0] = i * nchem + 0 ;
        matrix_data[ j + 0 ] = -k11[i]*H_2 - k12[i]*de - k13[i]*H_1 + k21[i]*H_1*H_1;




        // H2_1 by H2_2
        colvals[j + 1] = i * nchem + 1 ;
        matrix_data[ j + 1 ] = k10[i]*H_1 + k19[i]*H_m0;




        // H2_1 by H_1
        colvals[j + 2] = i * nchem + 2 ;
        matrix_data[ j + 2 ] = k08[i]*H_m0 + k10[i]*H2_2 - k13[i]*H2_1;




        // H2_1 by H_2
        colvals[j + 3] = i * nchem + 3 ;
        matrix_data[ j + 3 ] = -k11[i]*H2_1;




        // H2_1 by H_m0
        colvals[j + 4] = i * nchem + 4 ;
        matrix_data[ j + 4 ] = k08[i]*H_1 + k19[i]*H2_2;




        // H2_1 by de
        colvals[j + 5] = i * nchem + 8 ;
        matrix_data[ j + 5 ] = -k12[i]*H2_1;




        // H2_1 by ge
        colvals[j + 6] = i * nchem + 9 ;
        matrix_data[ j + 6 ] = rk08[i]*H_1*H_m0 + rk10[i]*H2_2*H_1 - rk11[i]*H2_1*H_2 - rk12[i]*H2_1*de - rk13[i]*H2_1*H_1 + rk19[i]*H2_2*H_m0 + rk21[i]*H2_1*H_1*H_1 + rk22[i]*H_1*H_1*H_1;



        matrix_data[ j + 6] *= Tge[i];


        // H2_2 by H2_1
        colvals[j + 7] = i * nchem + 0 ;
        matrix_data[ j + 7 ] = k11[i]*H_2;




        // H2_2 by H2_2
        colvals[j + 8] = i * nchem + 1 ;
        matrix_data[ j + 8 ] = -k10[i]*H_1 - k18[i]*de - k19[i]*H_m0;




        // H2_2 by H_1
        colvals[j + 9] = i * nchem + 2 ;
        matrix_data[ j + 9 ] = k09[i]*H_2 - k10[i]*H2_2;




        // H2_2 by H_2
        colvals[j + 10] = i * nchem + 3 ;
        matrix_data[ j + 10 ] = k09[i]*H_1 + k11[i]*H2_1 + k17[i]*H_m0;




        // H2_2 by H_m0
        colvals[j + 11] = i * nchem + 4 ;
        matrix_data[ j + 11 ] = k17[i]*H_2 - k19[i]*H2_2;




        // H2_2 by de
        colvals[j + 12] = i * nchem + 8 ;
        matrix_data[ j + 12 ] = -k18[i]*H2_2;




        // H2_2 by ge
        colvals[j + 13] = i * nchem + 9 ;
        matrix_data[ j + 13 ] = rk09[i]*H_1*H_2 - rk10[i]*H2_2*H_1 + rk11[i]*H2_1*H_2 + rk17[i]*H_2*H_m0 - rk18[i]*H2_2*de - rk19[i]*H2_2*H_m0;



        matrix_data[ j + 13] *= Tge[i];


        // H_1 by H2_1
        colvals[j + 14] = i * nchem + 0 ;
        matrix_data[ j + 14 ] = k11[i]*H_2 + 2*k12[i]*de + 2*k13[i]*H_1 - 2*k21[i]*H_1*H_1;




        // H_1 by H2_2
        colvals[j + 15] = i * nchem + 1 ;
        matrix_data[ j + 15 ] = -k10[i]*H_1 + 2*k18[i]*de + k19[i]*H_m0;




        // H_1 by H_1
        colvals[j + 16] = i * nchem + 2 ;
        matrix_data[ j + 16 ] = -k01[i]*de - k07[i]*de - k08[i]*H_m0 - k09[i]*H_2 - k10[i]*H2_2 + 2*k13[i]*H2_1 + k15[i]*H_m0;




        // H_1 by H_2
        colvals[j + 17] = i * nchem + 3 ;
        matrix_data[ j + 17 ] = k02[i]*de - k09[i]*H_1 + k11[i]*H2_1 + 2*k16[i]*H_m0;




        // H_1 by H_m0
        colvals[j + 18] = i * nchem + 4 ;
        matrix_data[ j + 18 ] = -k08[i]*H_1 + k14[i]*de + k15[i]*H_1 + 2*k16[i]*H_2 + k19[i]*H2_2;




        // H_1 by de
        colvals[j + 19] = i * nchem + 8 ;
        matrix_data[ j + 19 ] = -k01[i]*H_1 + k02[i]*H_2 - k07[i]*H_1 + 2*k12[i]*H2_1 + k14[i]*H_m0 + 2*k18[i]*H2_2;




        // H_1 by ge
        colvals[j + 20] = i * nchem + 9 ;
        matrix_data[ j + 20 ] = -rk01[i]*H_1*de + rk02[i]*H_2*de - rk07[i]*H_1*de - rk08[i]*H_1*H_m0 - rk09[i]*H_1*H_2 - rk10[i]*H2_2*H_1 + rk11[i]*H2_1*H_2 + 2*rk12[i]*H2_1*de + 2*rk13[i]*H2_1*H_1 + rk14[i]*H_m0*de + rk15[i]*H_1*H_m0 + 2*rk16[i]*H_2*H_m0 + 2*rk18[i]*H2_2*de + rk19[i]*H2_2*H_m0 - 2*rk21[i]*H2_1*H_1*H_1 - 2*rk22[i]*H_1*H_1*H_1;



        matrix_data[ j + 20] *= Tge[i];


        // H_2 by H2_1
        colvals[j + 21] = i * nchem + 0 ;
        matrix_data[ j + 21 ] = -k11[i]*H_2;




        // H_2 by H2_2
        colvals[j + 22] = i * nchem + 1 ;
        matrix_data[ j + 22 ] = k10[i]*H_1;




        // H_2 by H_1
        colvals[j + 23] = i * nchem + 2 ;
        matrix_data[ j + 23 ] = k01[i]*de - k09[i]*H_2 + k10[i]*H2_2;




        // H_2 by H_2
        colvals[j + 24] = i * nchem + 3 ;
        matrix_data[ j + 24 ] = -k02[i]*de - k09[i]*H_1 - k11[i]*H2_1 - k16[i]*H_m0 - k17[i]*H_m0;




        // H_2 by H_m0
        colvals[j + 25] = i * nchem + 4 ;
        matrix_data[ j + 25 ] = -k16[i]*H_2 - k17[i]*H_2;




        // H_2 by de
        colvals[j + 26] = i * nchem + 8 ;
        matrix_data[ j + 26 ] = k01[i]*H_1 - k02[i]*H_2;




        // H_2 by ge
        colvals[j + 27] = i * nchem + 9 ;
        matrix_data[ j + 27 ] = rk01[i]*H_1*de - rk02[i]*H_2*de - rk09[i]*H_1*H_2 + rk10[i]*H2_2*H_1 - rk11[i]*H2_1*H_2 - rk16[i]*H_2*H_m0 - rk17[i]*H_2*H_m0;



        matrix_data[ j + 27] *= Tge[i];


        // H_m0 by H2_2
        colvals[j + 28] = i * nchem + 1 ;
        matrix_data[ j + 28 ] = -k19[i]*H_m0;




        // H_m0 by H_1
        colvals[j + 29] = i * nchem + 2 ;
        matrix_data[ j + 29 ] = k07[i]*de - k08[i]*H_m0 - k15[i]*H_m0;




        // H_m0 by H_2
        colvals[j + 30] = i * nchem + 3 ;
        matrix_data[ j + 30 ] = -k16[i]*H_m0 - k17[i]*H_m0;




        // H_m0 by H_m0
        colvals[j + 31] = i * nchem + 4 ;
        matrix_data[ j + 31 ] = -k08[i]*H_1 - k14[i]*de - k15[i]*H_1 - k16[i]*H_2 - k17[i]*H_2 - k19[i]*H2_2;




        // H_m0 by de
        colvals[j + 32] = i * nchem + 8 ;
        matrix_data[ j + 32 ] = k07[i]*H_1 - k14[i]*H_m0;




        // H_m0 by ge
        colvals[j + 33] = i * nchem + 9 ;
        matrix_data[ j + 33 ] = rk07[i]*H_1*de - rk08[i]*H_1*H_m0 - rk14[i]*H_m0*de - rk15[i]*H_1*H_m0 - rk16[i]*H_2*H_m0 - rk17[i]*H_2*H_m0 - rk19[i]*H2_2*H_m0;



        matrix_data[ j + 33] *= Tge[i];


        // He_1 by He_1
        colvals[j + 34] = i * nchem + 5 ;
        matrix_data[ j + 34 ] = -k03[i]*de;




        // He_1 by He_2
        colvals[j + 35] = i * nchem + 6 ;
        matrix_data[ j + 35 ] = k04[i]*de;




        // He_1 by de
        colvals[j + 36] = i * nchem + 8 ;
        matrix_data[ j + 36 ] = -k03[i]*He_1 + k04[i]*He_2;




        // He_1 by ge
        colvals[j + 37] = i * nchem + 9 ;
        matrix_data[ j + 37 ] = -rk03[i]*He_1*de + rk04[i]*He_2*de;



        matrix_data[ j + 37] *= Tge[i];


        // He_2 by He_1
        colvals[j + 38] = i * nchem + 5 ;
        matrix_data[ j + 38 ] = k03[i]*de;




        // He_2 by He_2
        colvals[j + 39] = i * nchem + 6 ;
        matrix_data[ j + 39 ] = -k04[i]*de - k05[i]*de;




        // He_2 by He_3
        colvals[j + 40] = i * nchem + 7 ;
        matrix_data[ j + 40 ] = k06[i]*de;




        // He_2 by de
        colvals[j + 41] = i * nchem + 8 ;
        matrix_data[ j + 41 ] = k03[i]*He_1 - k04[i]*He_2 - k05[i]*He_2 + k06[i]*He_3;




        // He_2 by ge
        colvals[j + 42] = i * nchem + 9 ;
        matrix_data[ j + 42 ] = rk03[i]*He_1*de - rk04[i]*He_2*de - rk05[i]*He_2*de + rk06[i]*He_3*de;



        matrix_data[ j + 42] *= Tge[i];


        // He_3 by He_2
        colvals[j + 43] = i * nchem + 6 ;
        matrix_data[ j + 43 ] = k05[i]*de;




        // He_3 by He_3
        colvals[j + 44] = i * nchem + 7 ;
        matrix_data[ j + 44 ] = -k06[i]*de;




        // He_3 by de
        colvals[j + 45] = i * nchem + 8 ;
        matrix_data[ j + 45 ] = k05[i]*He_2 - k06[i]*He_3;




        // He_3 by ge
        colvals[j + 46] = i * nchem + 9 ;
        matrix_data[ j + 46 ] = rk05[i]*He_2*de - rk06[i]*He_3*de;



        matrix_data[ j + 46] *= Tge[i];


        // de by H2_2
        colvals[j + 47] = i * nchem + 1 ;
        matrix_data[ j + 47 ] = -k18[i]*de;




        // de by H_1
        colvals[j + 48] = i * nchem + 2 ;
        matrix_data[ j + 48 ] = k01[i]*de - k07[i]*de + k08[i]*H_m0 + k15[i]*H_m0;




        // de by H_2
        colvals[j + 49] = i * nchem + 3 ;
        matrix_data[ j + 49 ] = -k02[i]*de + k17[i]*H_m0;




        // de by H_m0
        colvals[j + 50] = i * nchem + 4 ;
        matrix_data[ j + 50 ] = k08[i]*H_1 + k14[i]*de + k15[i]*H_1 + k17[i]*H_2;




        // de by He_1
        colvals[j + 51] = i * nchem + 5 ;
        matrix_data[ j + 51 ] = k03[i]*de;




        // de by He_2
        colvals[j + 52] = i * nchem + 6 ;
        matrix_data[ j + 52 ] = -k04[i]*de + k05[i]*de;




        // de by He_3
        colvals[j + 53] = i * nchem + 7 ;
        matrix_data[ j + 53 ] = -k06[i]*de;




        // de by de
        colvals[j + 54] = i * nchem + 8 ;
        matrix_data[ j + 54 ] = k01[i]*H_1 - k02[i]*H_2 + k03[i]*He_1 - k04[i]*He_2 + k05[i]*He_2 - k06[i]*He_3 - k07[i]*H_1 + k14[i]*H_m0 - k18[i]*H2_2;




        // de by ge
        colvals[j + 55] = i * nchem + 9 ;
        matrix_data[ j + 55 ] = rk01[i]*H_1*de - rk02[i]*H_2*de + rk03[i]*He_1*de - rk04[i]*He_2*de + rk05[i]*He_2*de - rk06[i]*He_3*de - rk07[i]*H_1*de + rk08[i]*H_1*H_m0 + rk14[i]*H_m0*de + rk15[i]*H_1*H_m0 + rk17[i]*H_2*H_m0 - rk18[i]*H2_2*de;



        matrix_data[ j + 55] *= Tge[i];


        // ge by H2_1
        colvals[j + 56] = i * nchem + 0 ;
        matrix_data[ j + 56 ] = (-H2_1*gloverabel08_gaH2[i]*pow(gloverabel08_h2lte[i], 2)/(pow(gloverabel08_h2lte[i]/(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i]) + 1.0, 2)*pow(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i], 2)) - 0.5*H_1*h2formation_h2mcool[i]*1.0/(h2formation_ncrn[i]/(H2_1*h2formation_ncrd2[i] + H_1*h2formation_ncrd1[i]) + 1.0) - gloverabel08_h2lte[i]/(gloverabel08_h2lte[i]/(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i]) + 1.0) + 0.5*h2formation_ncrd2[i]*h2formation_ncrn[i]*pow(h2formation_ncrn[i]/(H2_1*h2formation_ncrd2[i] + H_1*h2formation_ncrd1[i]) + 1.0, -2.0)*(-H2_1*H_1*h2formation_h2mcool[i] + pow(H_1, 3)*h2formation_h2mheat[i])/pow(H2_1*h2formation_ncrd2[i] + H_1*h2formation_ncrd1[i], 2))*fmin(1.00000000000000, (1.0 - exp(-fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8))))/fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8)));


        matrix_data[j + 56] *= inv_mdensity;



        // ge by H_1
        colvals[j + 57] = i * nchem + 2 ;
        matrix_data[ j + 57 ] = (-H2_1*gloverabel08_gaHI[i]*pow(gloverabel08_h2lte[i], 2)/(pow(gloverabel08_h2lte[i]/(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i]) + 1.0, 2)*pow(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i], 2)) - ceHI_ceHI[i]*de - ciHI_ciHI[i]*de + 0.5*h2formation_ncrd1[i]*h2formation_ncrn[i]*pow(h2formation_ncrn[i]/(H2_1*h2formation_ncrd2[i] + H_1*h2formation_ncrd1[i]) + 1.0, -2.0)*(-H2_1*H_1*h2formation_h2mcool[i] + pow(H_1, 3)*h2formation_h2mheat[i])/pow(H2_1*h2formation_ncrd2[i] + H_1*h2formation_ncrd1[i], 2) + 0.5*(-H2_1*h2formation_h2mcool[i] + 3*pow(H_1, 2)*h2formation_h2mheat[i])*1.0/(h2formation_ncrn[i]/(H2_1*h2formation_ncrd2[i] + H_1*h2formation_ncrd1[i]) + 1.0))*fmin(1.00000000000000, (1.0 - exp(-fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8))))/fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8)));


        matrix_data[j + 57] *= inv_mdensity;



        // ge by H_2
        colvals[j + 58] = i * nchem + 3 ;
        matrix_data[ j + 58 ] = (-H2_1*gloverabel08_gaHp[i]*pow(gloverabel08_h2lte[i], 2)/(pow(gloverabel08_h2lte[i]/(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i]) + 1.0, 2)*pow(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i], 2)) - brem_brem[i]*de - de*reHII_reHII[i])*fmin(1.00000000000000, (1.0 - exp(-fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8))))/fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8)));


        matrix_data[j + 58] *= inv_mdensity;



        // ge by He_1
        colvals[j + 59] = i * nchem + 5 ;
        matrix_data[ j + 59 ] = (-H2_1*gloverabel08_gaHe[i]*pow(gloverabel08_h2lte[i], 2)/(pow(gloverabel08_h2lte[i]/(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i]) + 1.0, 2)*pow(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i], 2)) - ciHeI_ciHeI[i]*de)*fmin(1.00000000000000, (1.0 - exp(-fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8))))/fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8)));


        matrix_data[j + 59] *= inv_mdensity;



        // ge by He_2
        colvals[j + 60] = i * nchem + 6 ;
        matrix_data[ j + 60 ] = (-brem_brem[i]*de - ceHeII_ceHeII[i]*de - ceHeI_ceHeI[i]*pow(de, 2) - ciHeII_ciHeII[i]*de - ciHeIS_ciHeIS[i]*pow(de, 2) - de*reHeII1_reHeII1[i] - de*reHeII2_reHeII2[i])*fmin(1.00000000000000, (1.0 - exp(-fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8))))/fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8)));


        matrix_data[j + 60] *= inv_mdensity;



        // ge by He_3
        colvals[j + 61] = i * nchem + 7 ;
        matrix_data[ j + 61 ] = (-4.0*brem_brem[i]*de - de*reHeIII_reHeIII[i])*fmin(1.00000000000000, (1.0 - exp(-fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8))))/fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8)));


        matrix_data[j + 61] *= inv_mdensity;



        // ge by de
        colvals[j + 62] = i * nchem + 8 ;
        matrix_data[ j + 62 ] = (-H2_1*gloverabel08_gael[i]*pow(gloverabel08_h2lte[i], 2)/(pow(gloverabel08_h2lte[i]/(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i]) + 1.0, 2)*pow(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i], 2)) - H_1*ceHI_ceHI[i] - H_1*ciHI_ciHI[i] - H_2*reHII_reHII[i] - He_1*ciHeI_ciHeI[i] - He_2*ceHeII_ceHeII[i] - 2*He_2*ceHeI_ceHeI[i]*de - He_2*ciHeII_ciHeII[i] - 2*He_2*ciHeIS_ciHeIS[i]*de - He_2*reHeII1_reHeII1[i] - He_2*reHeII2_reHeII2[i] - He_3*reHeIII_reHeIII[i] - brem_brem[i]*(H_2 + He_2 + 4.0*He_3) - compton_comp_[i]*pow(z + 1.0, 4)*(T - 2.73*z - 2.73))*fmin(1.00000000000000, (1.0 - exp(-fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8))))/fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8)));


        matrix_data[j + 62] *= inv_mdensity;



        // ge by ge
        colvals[j + 63] = i * nchem + 9 ;
        matrix_data[ j + 63 ] = (-H2_1*gloverabel08_h2lte[i]/(gloverabel08_h2lte[i]/(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i]) + 1.0) - H_1*ceHI_ceHI[i]*de - H_1*ciHI_ciHI[i]*de - H_2*de*reHII_reHII[i] - He_1*ciHeI_ciHeI[i]*de - He_2*ceHeII_ceHeII[i]*de - He_2*ceHeI_ceHeI[i]*pow(de, 2) - He_2*ciHeII_ciHeII[i]*de - He_2*ciHeIS_ciHeIS[i]*pow(de, 2) - He_2*de*reHeII1_reHeII1[i] - He_2*de*reHeII2_reHeII2[i] - He_3*de*reHeIII_reHeIII[i] - brem_brem[i]*de*(H_2 + He_2 + 4.0*He_3) - compton_comp_[i]*de*pow(z + 1.0, 4)*(T - 2.73*z - 2.73) + 0.5*1.0/(h2formation_ncrn[i]/(H2_1*h2formation_ncrd2[i] + H_1*h2formation_ncrd1[i]) + 1.0)*(-H2_1*H_1*h2formation_h2mcool[i] + pow(H_1, 3)*h2formation_h2mheat[i]))*fmin(1.00000000000000, (1.0 - exp(-fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8))))/fmax(1.00000000000000e-5, 8.87484891418606e+20*pow(mdensity, 2.8)));

        // ad-hoc extra term of ge by ge
        // considering ONLY the h2formation/ and continuum cooling
        matrix_data[ j + 63] =  -H2_1*gloverabel08_h2lte[i]*(-gloverabel08_h2lte[i]*(-H2_1*rgloverabel08_gaH2[i] - H_1*rgloverabel08_gaHI[i] - H_2*rgloverabel08_gaHp[i] - He_1*rgloverabel08_gaHe[i] - de*rgloverabel08_gael[i])/pow(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i], 2) - rgloverabel08_h2lte[i]/(H2_1*gloverabel08_gaH2[i] +
        H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i]))/pow(gloverabel08_h2lte[i]/(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] + de*gloverabel08_gael[i]) + 1.0, 2) - H2_1*rgloverabel08_h2lte[i]/(gloverabel08_h2lte[i]/(H2_1*gloverabel08_gaH2[i] + H_1*gloverabel08_gaHI[i] + H_2*gloverabel08_gaHp[i] + He_1*gloverabel08_gaHe[i] +
        de*gloverabel08_gael[i]) + 1.0) - compton_comp_[i]*de*pow(z + 1.0, 4) + 0.5*pow(h2formation_ncrn[i]/(H2_1*h2formation_ncrd2[i] + H_1*h2formation_ncrd1[i]) + 1.0, -2.0)*(-H2_1*H_1*h2formation_h2mcool[i] + pow(H_1, 3)*h2formation_h2mheat[i])*(-1.0*h2formation_ncrn[i]*(-H2_1*rh2formation_ncrd2[i] - H_1*rh2formation_ncrd1[i])/pow(H2_1*h2formation_ncrd2[i] + H_1*h2formation_ncrd1[i], 2) - 1.0*rh2formation_ncrn[i]/(H2_1*h2formation_ncrd2[i] +
        H_1*h2formation_ncrd1[i])) + 0.5*1.0/(h2formation_ncrn[i]/(H2_1*h2formation_ncrd2[i] + H_1*h2formation_ncrd1[i]) + 1.0)*(-H2_1*H_1*rh2formation_h2mcool[i] + pow(H_1, 3)*rh2formation_h2mheat[i]);


        matrix_data[j + 63] *= inv_mdensity;


        matrix_data[ j + 63] *= Tge[i];




        rowptrs[ i * nchem +  0] = i * 64 + 0;

        rowptrs[ i * nchem +  1] = i * 64 + 7;

        rowptrs[ i * nchem +  2] = i * 64 + 14;

        rowptrs[ i * nchem +  3] = i * 64 + 21;

        rowptrs[ i * nchem +  4] = i * 64 + 28;

        rowptrs[ i * nchem +  5] = i * 64 + 34;

        rowptrs[ i * nchem +  6] = i * 64 + 38;

        rowptrs[ i * nchem +  7] = i * 64 + 43;

        rowptrs[ i * nchem +  8] = i * 64 + 47;

        rowptrs[ i * nchem +  9] = i * 64 + 56;


        j = i * nchem;

        inv_scale1 = inv_scale[ j + 0 ];
        scale2     = scale    [ j + 0 ];
        matrix_data[ i * 64 + 0]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 0 ];
        scale2     = scale    [ j + 1 ];
        matrix_data[ i * 64 + 1]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 0 ];
        scale2     = scale    [ j + 2 ];
        matrix_data[ i * 64 + 2]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 0 ];
        scale2     = scale    [ j + 3 ];
        matrix_data[ i * 64 + 3]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 0 ];
        scale2     = scale    [ j + 4 ];
        matrix_data[ i * 64 + 4]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 0 ];
        scale2     = scale    [ j + 8 ];
        matrix_data[ i * 64 + 5]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 0 ];
        scale2     = scale    [ j + 9 ];
        matrix_data[ i * 64 + 6]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 1 ];
        scale2     = scale    [ j + 0 ];
        matrix_data[ i * 64 + 7]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 1 ];
        scale2     = scale    [ j + 1 ];
        matrix_data[ i * 64 + 8]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 1 ];
        scale2     = scale    [ j + 2 ];
        matrix_data[ i * 64 + 9]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 1 ];
        scale2     = scale    [ j + 3 ];
        matrix_data[ i * 64 + 10]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 1 ];
        scale2     = scale    [ j + 4 ];
        matrix_data[ i * 64 + 11]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 1 ];
        scale2     = scale    [ j + 8 ];
        matrix_data[ i * 64 + 12]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 1 ];
        scale2     = scale    [ j + 9 ];
        matrix_data[ i * 64 + 13]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 2 ];
        scale2     = scale    [ j + 0 ];
        matrix_data[ i * 64 + 14]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 2 ];
        scale2     = scale    [ j + 1 ];
        matrix_data[ i * 64 + 15]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 2 ];
        scale2     = scale    [ j + 2 ];
        matrix_data[ i * 64 + 16]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 2 ];
        scale2     = scale    [ j + 3 ];
        matrix_data[ i * 64 + 17]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 2 ];
        scale2     = scale    [ j + 4 ];
        matrix_data[ i * 64 + 18]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 2 ];
        scale2     = scale    [ j + 8 ];
        matrix_data[ i * 64 + 19]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 2 ];
        scale2     = scale    [ j + 9 ];
        matrix_data[ i * 64 + 20]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 3 ];
        scale2     = scale    [ j + 0 ];
        matrix_data[ i * 64 + 21]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 3 ];
        scale2     = scale    [ j + 1 ];
        matrix_data[ i * 64 + 22]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 3 ];
        scale2     = scale    [ j + 2 ];
        matrix_data[ i * 64 + 23]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 3 ];
        scale2     = scale    [ j + 3 ];
        matrix_data[ i * 64 + 24]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 3 ];
        scale2     = scale    [ j + 4 ];
        matrix_data[ i * 64 + 25]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 3 ];
        scale2     = scale    [ j + 8 ];
        matrix_data[ i * 64 + 26]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 3 ];
        scale2     = scale    [ j + 9 ];
        matrix_data[ i * 64 + 27]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 4 ];
        scale2     = scale    [ j + 1 ];
        matrix_data[ i * 64 + 28]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 4 ];
        scale2     = scale    [ j + 2 ];
        matrix_data[ i * 64 + 29]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 4 ];
        scale2     = scale    [ j + 3 ];
        matrix_data[ i * 64 + 30]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 4 ];
        scale2     = scale    [ j + 4 ];
        matrix_data[ i * 64 + 31]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 4 ];
        scale2     = scale    [ j + 8 ];
        matrix_data[ i * 64 + 32]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 4 ];
        scale2     = scale    [ j + 9 ];
        matrix_data[ i * 64 + 33]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 5 ];
        scale2     = scale    [ j + 5 ];
        matrix_data[ i * 64 + 34]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 5 ];
        scale2     = scale    [ j + 6 ];
        matrix_data[ i * 64 + 35]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 5 ];
        scale2     = scale    [ j + 8 ];
        matrix_data[ i * 64 + 36]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 5 ];
        scale2     = scale    [ j + 9 ];
        matrix_data[ i * 64 + 37]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 6 ];
        scale2     = scale    [ j + 5 ];
        matrix_data[ i * 64 + 38]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 6 ];
        scale2     = scale    [ j + 6 ];
        matrix_data[ i * 64 + 39]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 6 ];
        scale2     = scale    [ j + 7 ];
        matrix_data[ i * 64 + 40]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 6 ];
        scale2     = scale    [ j + 8 ];
        matrix_data[ i * 64 + 41]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 6 ];
        scale2     = scale    [ j + 9 ];
        matrix_data[ i * 64 + 42]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 7 ];
        scale2     = scale    [ j + 6 ];
        matrix_data[ i * 64 + 43]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 7 ];
        scale2     = scale    [ j + 7 ];
        matrix_data[ i * 64 + 44]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 7 ];
        scale2     = scale    [ j + 8 ];
        matrix_data[ i * 64 + 45]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 7 ];
        scale2     = scale    [ j + 9 ];
        matrix_data[ i * 64 + 46]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 8 ];
        scale2     = scale    [ j + 1 ];
        matrix_data[ i * 64 + 47]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 8 ];
        scale2     = scale    [ j + 2 ];
        matrix_data[ i * 64 + 48]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 8 ];
        scale2     = scale    [ j + 3 ];
        matrix_data[ i * 64 + 49]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 8 ];
        scale2     = scale    [ j + 4 ];
        matrix_data[ i * 64 + 50]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 8 ];
        scale2     = scale    [ j + 5 ];
        matrix_data[ i * 64 + 51]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 8 ];
        scale2     = scale    [ j + 6 ];
        matrix_data[ i * 64 + 52]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 8 ];
        scale2     = scale    [ j + 7 ];
        matrix_data[ i * 64 + 53]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 8 ];
        scale2     = scale    [ j + 8 ];
        matrix_data[ i * 64 + 54]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 8 ];
        scale2     = scale    [ j + 9 ];
        matrix_data[ i * 64 + 55]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 9 ];
        scale2     = scale    [ j + 0 ];
        matrix_data[ i * 64 + 56]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 9 ];
        scale2     = scale    [ j + 2 ];
        matrix_data[ i * 64 + 57]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 9 ];
        scale2     = scale    [ j + 3 ];
        matrix_data[ i * 64 + 58]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 9 ];
        scale2     = scale    [ j + 5 ];
        matrix_data[ i * 64 + 59]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 9 ];
        scale2     = scale    [ j + 6 ];
        matrix_data[ i * 64 + 60]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 9 ];
        scale2     = scale    [ j + 7 ];
        matrix_data[ i * 64 + 61]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 9 ];
        scale2     = scale    [ j + 8 ];
        matrix_data[ i * 64 + 62]  *= inv_scale1*scale2;

        inv_scale1 = inv_scale[ j + 9 ];
        scale2     = scale    [ j + 9 ];
        matrix_data[ i * 64 + 63]  *= inv_scale1*scale2;



    }

    rowptrs[ i * nchem ] = i * 64 ;

    //SUNSparseMatrix_Print( J , stderr );
    return 0;
}

#endif
